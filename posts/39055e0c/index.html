<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png"><link rel="icon" type="image/png" href="/img/site.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content="Jipeng Hao 的个人博客"><meta name="author" content="Martentite"><meta name="keywords" content="java, python, blog"><title>Chapter2 索引优化 - 山那边的小木屋</title><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/prism/1.21.0/themes/prism-okaidia.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="山那边的小木屋" type="application/atom+xml">
</head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>Jacob</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner intro-2" id="background" parallax="true" style="background:url(/img/post/banner/cat.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="container page-header text-center fade-in-up"><span class="h2" id="subtitle"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Martentite </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-02-06 00:02" pubdate>2021年2月6日 凌晨</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 4.8k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 71 分钟</span></div></div></div></div></div></header><main><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="container nopadding-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto" id="post"><h1 style="display:none">Chapter2 索引优化</h1><div class="markdown-body" id="post-body"><h2 id="2-1-背景知识"><a href="#2-1-背景知识" class="headerlink" title="2.1 背景知识"></a>2.1 背景知识</h2><h3 id="2-1-1-性能下降原因"><a href="#2-1-1-性能下降原因" class="headerlink" title="2.1.1 性能下降原因"></a>2.1.1 性能下降原因</h3><ol><li>查询语言不合理</li><li>索引失效</li><li>关联表过多</li><li>服务器调优及各个参数设置</li></ol><h3 id="2-1-2-SQL-执行顺序"><a href="#2-1-2-SQL-执行顺序" class="headerlink" title="2.1.2 SQL 执行顺序"></a>2.1.2 SQL 执行顺序</h3><ol><li><p>手写</p><pre class="language-none"><code class="language-none">select -&gt; from -&gt; on -&gt; where -&gt; group by -&gt; having -&gt; order by</code></pre></li><li><p>机读<br><img src="https://raw.githubusercontent.com/JabinHao/mihs/master/blog/MySQL/2-1-2.png" srcset="/img/loading.gif"></p></li></ol><h3 id="2-1-3-七种-Join"><a href="#2-1-3-七种-Join" class="headerlink" title="2.1.3 七种 Join"></a>2.1.3 七种 Join</h3><ol><li><p>INNER JOIN<br><img src="https://raw.githubusercontent.com/JabinHao/mihs/master/blog/MySQL/2-1-2_1.png" srcset="/img/loading.gif" alt="INNER JOIN"></p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> table1
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> table2
<span class="token keyword">ON</span> table1<span class="token punctuation">.</span><span class="token keyword">key</span> <span class="token operator">=</span> table2<span class="token punctuation">.</span><span class="token keyword">key</span><span class="token punctuation">;</span></code></pre></li><li><p>FULL [OUTER] JOIN</p><p><img src="https://raw.githubusercontent.com/JabinHao/mihs/master/blog/MySQL/2-1-2_2.png" srcset="/img/loading.gif" alt="FULL [OUTER] JOIN"></p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> table1
<span class="token keyword">FULL</span> <span class="token keyword">JOIN</span> table2
<span class="token keyword">ON</span> table1<span class="token punctuation">.</span><span class="token keyword">key</span> <span class="token operator">=</span> table2<span class="token punctuation">.</span><span class="token keyword">key</span><span class="token punctuation">;</span></code></pre></li><li><p>FULL [OUTER] JOIN without the intersection</p><p><img src="https://raw.githubusercontent.com/JabinHao/mihs/master/blog/MySQL/2-1-2_3.png" srcset="/img/loading.gif" alt="FULL [OUTER] JOIN without the intersection"></p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> table1
<span class="token keyword">FULL</span> <span class="token keyword">JOIN</span> table2
<span class="token keyword">ON</span> table1<span class="token punctuation">.</span><span class="token keyword">key</span> <span class="token operator">=</span> table2<span class="token punctuation">.</span><span class="token keyword">key</span>
<span class="token keyword">WHERE</span> table1<span class="token punctuation">.</span><span class="token keyword">key</span> <span class="token operator">IS</span> <span class="token boolean">NULL</span>
<span class="token operator">OR</span> table2<span class="token punctuation">.</span><span class="token keyword">key</span> <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></code></pre></li><li><p>LEFT [OUTER] JOIN</p><p><img src="https://raw.githubusercontent.com/JabinHao/mihs/master/blog/MySQL/2-1-2_4.png" srcset="/img/loading.gif" alt="LEFT [OUTER] JOIN"></p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> table1
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> table2
<span class="token keyword">ON</span> table1<span class="token punctuation">.</span><span class="token keyword">key</span> <span class="token operator">=</span> table2<span class="token punctuation">.</span><span class="token keyword">key</span></code></pre></li><li><p>LEFT [OUTER] JOIN without the intersection</p><p><img src="https://raw.githubusercontent.com/JabinHao/mihs/master/blog/MySQL/2-1-2_5.png" srcset="/img/loading.gif" alt="LEFT [OUTER] JOIN without the intersection"></p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> table1
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> table2
<span class="token keyword">ON</span> table1<span class="token punctuation">.</span><span class="token keyword">key</span> <span class="token operator">=</span> table2<span class="token punctuation">.</span><span class="token keyword">key</span>
<span class="token keyword">WHERE</span> table2<span class="token punctuation">.</span><span class="token keyword">key</span> <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></code></pre></li><li><p>RIGHT [OUTER] JOIN</p><p><img src="https://raw.githubusercontent.com/JabinHao/mihs/master/blog/MySQL/2-1-2_6.png" srcset="/img/loading.gif" alt="RIGHT [OUTER] JOIN"></p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> table1
<span class="token keyword">RIGHT</span> <span class="token keyword">JOIN</span> table2
<span class="token keyword">ON</span> table1<span class="token punctuation">.</span><span class="token keyword">key</span> <span class="token operator">=</span> table2<span class="token punctuation">.</span><span class="token keyword">key</span></code></pre></li><li><p>RIGHT [OUTER] JOIN without the intersection</p><p><img src="https://raw.githubusercontent.com/JabinHao/mihs/master/blog/MySQL/2-1-2_7.png" srcset="/img/loading.gif" alt="RIGHT [OUTER] JOIN without the intersection"></p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> table1
<span class="token keyword">RIGHT</span> <span class="token keyword">JOIN</span> table2
<span class="token keyword">ON</span> table1<span class="token punctuation">.</span><span class="token keyword">key</span> <span class="token operator">=</span> table2<span class="token punctuation">.</span><span class="token keyword">key</span>
<span class="token keyword">WHERE</span> table2<span class="token punctuation">.</span><span class="token keyword">key</span> <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></code></pre></li></ol><h3 id="2-1-4-实战"><a href="#2-1-4-实战" class="headerlink" title="2.1.4 实战"></a>2.1.4 实战</h3><ol><li><p>建表</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 建表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>tbl_emp<span class="token punctuation">`</span>
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span>     <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span>   <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>deptId<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>     <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">KEY</span> <span class="token punctuation">`</span>fk_dept_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>deptId<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>
<span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>tbl_dept<span class="token punctuation">`</span>
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span>       <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>deptName<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>locAdd<span class="token punctuation">`</span>   <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>
<span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8<span class="token punctuation">;</span>

<span class="token comment"># 数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_dept <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'RD'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_dept <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'HR'</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_dept <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'MK'</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_dept <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'MIS'</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_dept <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'FD'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'z3'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'z4'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'z5'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'w5'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'w6'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'s7'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'s8'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'s9'</span><span class="token punctuation">,</span> <span class="token number">51</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>七种查询</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 1.INNER JOIN</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> tbl_dept
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> tbl_emp
<span class="token keyword">ON</span> tbl_dept<span class="token punctuation">.</span>id <span class="token operator">=</span> tbl_emp<span class="token punctuation">.</span>deptId<span class="token punctuation">;</span>

<span class="token comment"># 2. 左外连接</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> tbl_emp
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> tbl_dept
<span class="token keyword">ON</span> tbl_dept<span class="token punctuation">.</span>id <span class="token operator">=</span>  tbl_emp<span class="token punctuation">.</span>deptId<span class="token punctuation">;</span>

<span class="token comment"># 3. 右外连接</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> tbl_emp
<span class="token keyword">RIGHT</span> <span class="token keyword">JOIN</span> tbl_dept
<span class="token keyword">ON</span> tbl_dept<span class="token punctuation">.</span>id <span class="token operator">=</span>  tbl_emp<span class="token punctuation">.</span>deptId<span class="token punctuation">;</span>

<span class="token comment"># 4. 左外连接去交集</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> tbl_emp
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> tbl_dept
<span class="token keyword">ON</span> tbl_emp<span class="token punctuation">.</span>deptId <span class="token operator">=</span> tbl_dept<span class="token punctuation">.</span>id
<span class="token keyword">WHERE</span> tbl_dept<span class="token punctuation">.</span>id <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token punctuation">;</span>

<span class="token comment"># 5. 右外连接去交集</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> tbl_emp
<span class="token keyword">RIGHT</span> <span class="token keyword">JOIN</span> tbl_dept
<span class="token keyword">ON</span> tbl_emp<span class="token punctuation">.</span>deptId <span class="token operator">=</span> tbl_dept<span class="token punctuation">.</span>id
<span class="token keyword">WHERE</span> tbl_emp<span class="token punctuation">.</span>deptId <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token punctuation">;</span>

<span class="token comment"># 6. 全外连接</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tbl_emp <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> tbl_dept <span class="token keyword">ON</span> tbl_emp<span class="token punctuation">.</span>deptId<span class="token operator">=</span>tbl_dept<span class="token punctuation">.</span>id
<span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tbl_emp <span class="token keyword">RIGHT</span> <span class="token keyword">JOIN</span> tbl_dept <span class="token keyword">ON</span> tbl_emp<span class="token punctuation">.</span>deptId<span class="token operator">=</span>tbl_dept<span class="token punctuation">.</span>id<span class="token punctuation">;</span>

<span class="token comment"># 7. 补集</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tbl_emp <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> tbl_dept <span class="token keyword">ON</span> tbl_emp<span class="token punctuation">.</span>deptId<span class="token operator">=</span>tbl_dept<span class="token punctuation">.</span>id
<span class="token keyword">WHERE</span> tbl_dept<span class="token punctuation">.</span>id <span class="token operator">IS</span> <span class="token boolean">NULL</span>
<span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tbl_emp <span class="token keyword">RIGHT</span> <span class="token keyword">JOIN</span> tbl_dept <span class="token keyword">ON</span> tbl_emp<span class="token punctuation">.</span>deptId<span class="token operator">=</span>tbl_dept<span class="token punctuation">.</span>id
<span class="token keyword">WHERE</span> deptId <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></code></pre></li></ol><h2 id="2-2-索引简介"><a href="#2-2-索引简介" class="headerlink" title="2.2 索引简介"></a>2.2 索引简介</h2><h3 id="2-2-1-索引概述"><a href="#2-2-1-索引概述" class="headerlink" title="2.2.1 索引概述"></a>2.2.1 索引概述</h3><ol><li><p>定义</p><ul><li>索引（index）是帮助MySQL高效获取数据的数据结构（有序）</li><li>索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式存储在磁盘上。索引是数据库中用来提高性能的最常用的工具</li></ul></li><li><p>索引示意</p><p><img src="https://raw.githubusercontent.com/JabinHao/mihs/master/blog/MySQL/2-2-1.png" srcset="/img/loading.gif"></p></li><li><p>索引优缺点</p><ul><li>类似于书籍的目录索引，提高数据检索的效率，降低数据库的IO成本。</li><li>通过索引列对数据进行排序，降低数据排序的成本，降低CPU的消耗</li><li>实际上索引也是一张表，该表中保存了主键与索引字段，并指向实体类的记录，所以索引列也是要占用空间的。</li><li>虽然索引大大提高了查询效率，同时却也降低更新表的速度。</li></ul></li></ol><h3 id="2-2-2-索引结构"><a href="#2-2-2-索引结构" class="headerlink" title="2.2.2 索引结构"></a>2.2.2 索引结构</h3><ol><li><p>索引是在MySQL的存储引擎层中实现的，而不是在服务器层实现的。所以每种存储引擎的索引都不一定完全相同，也不是所有的存储引擎都支持所有的索引类型的。</p></li><li><p>MySQL目前提供了以下4种索引</p><ul><li>BTREE 索引 ： 最常见的索引类型，大部分索引都支持 B 树索引。</li><li>HASH 索引：只有Memory引擎支持 ， 使用场景简单 。</li><li>R-tree 索引（空间索引）：空间索引是MyISAM引擎的一个特殊索引类型，主要用于地理空间数据类型，通常使用较少，不做特别介绍。</li><li>Full-text （全文索引） ：全文索引也是MyISAM的一个特殊索引类型，主要用于全文索引，InnoDB从Mysql5.6版本开始支持全文索引</li></ul></li><li><p>不同存储引擎对比</p><table><thead><tr><th align="center">索引</th><th align="center">InnoDB</th><th align="center">MyISAM</th><th align="center">Memory</th></tr></thead><tbody><tr><td align="center">BTREE</td><td align="center">支持</td><td align="center">支持</td><td align="center">支持</td></tr><tr><td align="center">HASH</td><td align="center">不支持</td><td align="center">不支持</td><td align="center">支持</td></tr><tr><td align="center">R-tree</td><td align="center">不支持</td><td align="center">支持</td><td align="center">不支持</td></tr><tr><td align="center">Full-text</td><td align="center">5.6以后支持</td><td align="center">支持</td><td align="center">不支持</td></tr></tbody></table></li><li><p>说明</p><ul><li>我们平常所说的索引，如果没有特别指明，都是指B+树（多路搜索树，并不一定是二叉的）结构组织的索引。</li><li>聚集索引、复合索引、前缀索引、唯一索引默认都是使用 B+tree 索引，统称为索引</li></ul></li></ol><h3 id="2-2-3-索引分类"><a href="#2-2-3-索引分类" class="headerlink" title="2.2.3 索引分类"></a>2.2.3 索引分类</h3><ol><li>单值索引 ：即一个索引只包含单个列，一个表可以有多个单列索引</li><li>唯一索引 ：索引列的值必须唯一，但允许有空值</li><li>复合索引 ：即一个索引包含多个列</li></ol><h3 id="2-2-4-基本语法"><a href="#2-2-4-基本语法" class="headerlink" title="2.2.4 基本语法"></a>2.2.4 基本语法</h3><ol><li><p>创建索引</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token punctuation">[</span><span class="token keyword">UNIQUE</span><span class="token operator">|</span>FULLTEXT<span class="token operator">|</span>SPATIAL<span class="token punctuation">]</span> <span class="token keyword">INDEX</span> index_name <span class="token punctuation">[</span><span class="token keyword">USING</span> index_type<span class="token punctuation">]</span>
<span class="token keyword">ON</span> tbl_name<span class="token punctuation">(</span>index_col_name<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></code></pre><ul><li>UNIQUE：唯一索引</li><li>index_type：默认 BTREE</li></ul></li><li><p>查看索引</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> table_name<span class="token punctuation">;</span></code></pre></li><li><p>删除索引</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> index_name <span class="token keyword">ON</span> tbl_name<span class="token punctuation">;</span></code></pre></li><li><p>ALTER命令</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> tb_name <span class="token keyword">add</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>column_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 该语句添加一个主键，这意味着索引值必须是唯一的，且不能为NULL</span>

<span class="token keyword">alter</span> <span class="token keyword">table</span> tb_name <span class="token keyword">add</span> <span class="token keyword">unique</span> index_name<span class="token punctuation">(</span>column_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 这条语句创建索引的值必须是唯一的（除了NULL外，NULL可能会出现多次）</span>

<span class="token keyword">alter</span> <span class="token keyword">table</span> tb_name <span class="token keyword">add</span> <span class="token keyword">index</span> index_name<span class="token punctuation">(</span>column_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 添加普通索引， 索引值可以出现多次。</span>

<span class="token keyword">alter</span> <span class="token keyword">table</span> tb_name <span class="token keyword">add</span> fulltext index_name<span class="token punctuation">(</span>column_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 该语句指定了索引为FULLTEXT， 用于全文索引</span></code></pre></li></ol><h3 id="2-2-5-索引设计原则"><a href="#2-2-5-索引设计原则" class="headerlink" title="2.2.5 索引设计原则"></a>2.2.5 索引设计原则</h3><ol><li>主键自动建立唯一索引</li><li>对查询频次较高，且数据量比较大的表建立索引</li><li>查询中与其他表关联的字段，外键关系建立索引</li><li>频繁更新的字段不适合建索引</li><li>where条件中用不到的字段不创建索引</li><li>高并发下倾向于创建组合索引</li><li>查询中排序的字段，排序字段若通过索引去访问将大大提高排序速度</li><li>查询中统计或者分组字段</li></ol><h2 id="2-3-性能分析"><a href="#2-3-性能分析" class="headerlink" title="2.3 性能分析"></a>2.3 性能分析</h2><h3 id="2-3-1-MySQL-Query-Optimizer"><a href="#2-3-1-MySQL-Query-Optimizer" class="headerlink" title="2.3.1 MySQL Query Optimizer"></a>2.3.1 MySQL Query Optimizer</h3><h3 id="2-3-2-MySQL常见瓶颈"><a href="#2-3-2-MySQL常见瓶颈" class="headerlink" title="2.3.2 MySQL常见瓶颈"></a>2.3.2 MySQL常见瓶颈</h3><ol><li>CPU</li><li>IO</li><li>服务器硬件性能瓶颈</li></ol><h3 id="2-3-3-优化SQL步骤"><a href="#2-3-3-优化SQL步骤" class="headerlink" title="2.3.3 优化SQL步骤"></a>2.3.3 优化SQL步骤</h3><ol><li><p>查看SQL执行频率</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 查看当前session不同语句执行次数</span>
<span class="token keyword">SHOW</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'Com_______'</span><span class="token punctuation">;</span>

<span class="token comment"># 查看总的执行次数</span>
<span class="token keyword">SHOW</span> <span class="token keyword">GLOBAL</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'Com_______'</span><span class="token punctuation">;</span>

<span class="token comment"># 查看Innodb</span>
<span class="token keyword">SHOW</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'Innodb_rows_%'</span><span class="token punctuation">;</span></code></pre></li><li><p>定位低效率执行SQL</p><ul><li>慢查询日志 : 通过慢查询日志定位那些执行效率较低的 SQL 语句</li><li>SHOW PROCESSLIST;</li></ul></li><li><p>explain 分析执行计划</p><pre class="language-none"><code class="language-none">explain SQL语句</code></pre><pre class="language-none"><code class="language-none">+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------+
| id | select_type | table    | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra |
+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------+
|  1 | SIMPLE      | tbl_dept | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    5 |   100.00 | NULL  |
+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------+</code></pre></li><li><p>show profile</p><ul><li>Mysql从5.0.37版本开始增加了对 show profiles 和 show profile 语句的支持。show profiles 能够在做SQL优化时帮助我们了解时间都耗费到哪里去了</li><li>通过 have_profiling 参数，能够看到当前MySQL是否支持profile<pre class="language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">SELECT</span> @<span class="token variable">@have_profiling</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------------------+</span>
<span class="token operator">|</span> @<span class="token variable">@have_profiling</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+</span>
<span class="token operator">|</span> YES              <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+</span></code></pre></li><li>默认是关闭的，可以在session中开启<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">set</span> profiling<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span></code></pre></li><li>查看<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 查看所有sql语句耗时</span>
<span class="token keyword">SHOW</span> PROFILES<span class="token punctuation">;</span>

<span class="token comment"># 查看具体的sql语句</span>
<span class="token keyword">SHOW</span> PROFILE <span class="token keyword">FOR</span> QUERY query_id<span class="token punctuation">;</span>

<span class="token comment"># 进一步选择all、cpu、block io 、context switch、page faults等明细类型</span>
<span class="token keyword">SHOW</span> PROFILE CPU <span class="token keyword">FOR</span> QUERY query_id<span class="token punctuation">;</span></code></pre></li></ul></li><li><p>trace分析优化器执行计划</p><ul><li>MySQL5.6提供了对SQL的跟踪trace, 通过trace文件能够进一步了解为什么优化器选择A计划, 而不是选择B计划</li><li>打开trace ， 设置格式为 JSON，并设置trace最大能够使用的内存大小，避免解析过程中因为默认内存过小而不能够完整展示<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> OPTIMIZER_TRACE<span class="token operator">=</span><span class="token string">"enabled=on"</span><span class="token punctuation">,</span> END_MARKERS_IN_JSON<span class="token operator">=</span><span class="token keyword">on</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> OPTIMIZER_TRACE_MAX_MEM_SIZE<span class="token operator">=</span><span class="token number">100000</span><span class="token punctuation">;</span></code></pre></li><li>执行查询操作后，可以通过检查information_schema.optimizer_trace查看MySQL是如何执行SQL的<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>OPTIMIZER_TRACE\G<span class="token punctuation">;</span></code></pre></li></ul></li></ol><h3 id="2-3-4-explain字段"><a href="#2-3-4-explain字段" class="headerlink" title="2.3.4 explain字段"></a>2.3.4 explain字段</h3><ol><li><p>建表</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>t_role<span class="token punctuation">`</span>
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span>          <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>role_name<span class="token punctuation">`</span>   <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>role_code<span class="token punctuation">`</span>   <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>description<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>unique_role_name<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>role_name<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>
<span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>t_user<span class="token punctuation">`</span>
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span>       <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>username<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>password<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">96</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span>     <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>unique_user_username<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>username<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>
<span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>user_role<span class="token punctuation">`</span>
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span>      <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>role_id<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">KEY</span> <span class="token punctuation">`</span>fk_ur_user_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">KEY</span> <span class="token punctuation">`</span>fk_ur_role_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>role_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">CONSTRAINT</span> <span class="token punctuation">`</span>fk_ur_role_id<span class="token punctuation">`</span> <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>role_id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> <span class="token punctuation">`</span>t_role<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">ON</span>
        <span class="token keyword">DELETE</span> <span class="token keyword">NO</span> <span class="token keyword">ACTION</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">NO</span> <span class="token keyword">ACTION</span><span class="token punctuation">,</span>
    <span class="token keyword">CONSTRAINT</span> <span class="token punctuation">`</span>fk_ur_user_id<span class="token punctuation">`</span> <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> <span class="token punctuation">`</span>t_user<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">ON</span>
        <span class="token keyword">DELETE</span> <span class="token keyword">NO</span> <span class="token keyword">ACTION</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">NO</span> <span class="token keyword">ACTION</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>
<span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8<span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>t_user<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>username<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>password<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'super'</span><span class="token punctuation">,</span> <span class="token string">'$2a$10$TJ4TmCdK.X4wv/tCqHW14.w70U3CC33CeVncD3SLmyMXMknstqKRe'</span><span class="token punctuation">,</span> <span class="token string">'超级管理员'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>t_user<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>username<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>password<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'$2a$10$TJ4TmCdK.X4wv/tCqHW14.w70U3CC33CeVncD3SLmyMXMknstqKRe'</span><span class="token punctuation">,</span> <span class="token string">'系统管理员'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>t_user<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>username<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>password<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token string">'itcast'</span><span class="token punctuation">,</span> <span class="token string">'$2a$10$8qmaHgUFUAmPR5pOuWhYWOr291WJYjHelUlYn07k5ELF8ZCrW0Cui'</span><span class="token punctuation">,</span><span class="token string">'test02'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>t_user<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>username<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>password<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">,</span> <span class="token string">'stu1'</span><span class="token punctuation">,</span> <span class="token string">'$2a$10$pLtt2KDAFpwTWLjNsmTEi.oU1yOZyIn9XkziK/y/spH5rftCpUMZa'</span><span class="token punctuation">,</span> <span class="token string">'学生1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>t_user<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>username<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>password<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">,</span> <span class="token string">'stu2'</span><span class="token punctuation">,</span> <span class="token string">'$2a$10$nxPKkYSez7uz2YQYUnwhR.z57km3yqKn3Hr/p1FR6ZKgc18u.Tvqm'</span><span class="token punctuation">,</span> <span class="token string">'学生2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>t_user<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>username<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>password<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'6'</span><span class="token punctuation">,</span> <span class="token string">'t1'</span><span class="token punctuation">,</span> <span class="token string">'$2a$10$TJ4TmCdK.X4wv/tCqHW14.w70U3CC33CeVncD3SLmyMXMknstqKRe'</span><span class="token punctuation">,</span> <span class="token string">'老师1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>t_role<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>role_name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>role_code<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>description<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">,</span> <span class="token string">'学生'</span><span class="token punctuation">,</span> <span class="token string">'student'</span><span class="token punctuation">,</span> <span class="token string">'学生'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>t_role<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>role_name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>role_code<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>description<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'7'</span><span class="token punctuation">,</span> <span class="token string">'老师'</span><span class="token punctuation">,</span> <span class="token string">'teacher'</span><span class="token punctuation">,</span> <span class="token string">'老师'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>t_role<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>role_name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>role_code<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>description<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'8'</span><span class="token punctuation">,</span> <span class="token string">'教学管理员'</span><span class="token punctuation">,</span> <span class="token string">'teachmanager'</span><span class="token punctuation">,</span> <span class="token string">'教学管理员'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>t_role<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>role_name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>role_code<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>description<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'9'</span><span class="token punctuation">,</span> <span class="token string">'管理员'</span><span class="token punctuation">,</span> <span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'管理员'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>t_role<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>role_name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>role_code<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>description<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'10'</span><span class="token punctuation">,</span> <span class="token string">'超级管理员'</span><span class="token punctuation">,</span> <span class="token string">'super'</span><span class="token punctuation">,</span> <span class="token string">'超级管理员'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> user_role<span class="token punctuation">(</span>id<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> role_id<span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'5'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'7'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token string">'8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token string">'9'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token punctuation">,</span> <span class="token string">'8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'5'</span><span class="token punctuation">,</span> <span class="token string">'10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>id：查询的序列号</p><ul><li>id 相同表示加载表的顺序是从上到下</li><li>id 不同id值越大，优先级越高，越先被执行。</li><li>id 有相同，也有不同，同时存在。id相同的可以认为是一组，从上往下顺序执行；在所有的组中，id的值越大，优先级越高，越先执行</li></ul></li><li><p>select_type：表示 SELECT 的类型</p><table><thead><tr><th align="left">select_type</th><th align="left">含义</th></tr></thead><tbody><tr><td align="left">SIMPLE</td><td align="left">简单的select查询，查询中不包含子查询或者UNION</td></tr><tr><td align="left">PRIMARY</td><td align="left">查询中若包含任何复杂的子查询，最外层查询标记为该标识</td></tr><tr><td align="left">SUBQUERY</td><td align="left">在SELECT 或 WHERE 列表中包含了子查询</td></tr><tr><td align="left">DERIVED</td><td align="left">在FROM 列表中包含的子查询，被标记为 DERIVED（衍生） MYSQL会递归执行这些子查询，把结果放在临时表中</td></tr><tr><td align="left">UNION</td><td align="left">若第二个SELECT出现在UNION之后，则标记为UNION ； 若UNION包含在FROM子句的子查询中，外层SELECT将被标记为 ： DERIVED</td></tr><tr><td align="left">UNION RESULT</td><td align="left">从UNION表获取结果的SELECT</td></tr></tbody></table></li><li><p>table：展示这一行的数据是关于哪一张表的</p></li><li><p>type：访问类型</p><table><thead><tr><th align="left">type</th><th align="left">含义</th></tr></thead><tbody><tr><td align="left">NULL</td><td align="left">MySQL不访问任何表，索引，直接返回结果</td></tr><tr><td align="left">system</td><td align="left">表只有一行记录(等于系统表)，这是const类型的特例，一般不会出现</td></tr><tr><td align="left">const</td><td align="left">表示通过索引一次就找到了，const 用于比较primary key 或者 unique 索引。因为只匹配一行数据，所以很快。如将主键置于where列表中，MySQL 就能将该查询转换为一个常亮。const于将 “主键” 或 “唯一” 索引的所有部分与常量值进行比较</td></tr><tr><td align="left">eq_ref</td><td align="left">类似ref，区别在于使用的是唯一索引，使用主键的关联查询，关联查询出的记录只有一条。常见于主键或唯一索引扫描</td></tr><tr><td align="left">ref</td><td align="left">非唯一性索引扫描，返回匹配某个单独值的所有行。本质上也是一种索引访问，返回所有匹配某个单独值的所有行（多个）</td></tr><tr><td align="left">range</td><td align="left">只检索给定返回的行，使用一个索引来选择行。 where 之后出现 between ， &lt; , &gt; , in 等操作。</td></tr><tr><td align="left">index</td><td align="left">index 与 ALL的区别为 index 类型只是遍历了索引树， 通常比ALL 快， ALL 是遍历数据文件。</td></tr><tr><td align="left">all</td><td align="left">将遍历全表以找到匹配的行</td></tr></tbody></table></li><li><p>key</p><ul><li>possible_keys : 显示可能应用在这张表的索引， 一个或多个。</li><li>key ： 实际使用的索引， 如果为NULL， 则没有使用索引。</li><li>key_len : 表示索引中使用的字节数， 该值为索引字段最大可能长度，并非实际使用长度，在不损失精确性的前提下， 长度越短越好</li></ul></li><li><p>ref</p><ul><li>显示了之前的表在key列记录的索引中查找值所用的列或常量</li><li>const表示使用了常量</li></ul></li><li><p>extra</p><table><thead><tr><th align="left">extra</th><th align="left">含义</th></tr></thead><tbody><tr><td align="left">using filesort</td><td align="left">说明mysql会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取， 称为“文件排序”, 效率低。</td></tr><tr><td align="left">using temporary</td><td align="left">使用了临时表保存中间结果，MySQL在对查询结果排序时使用临时表。常见于 order by 和 group by； 效率低</td></tr><tr><td align="left">using index</td><td align="left">表示相应的select操作使用了覆盖索引， 避免访问表的数据行， 效率不错。</td></tr></tbody></table></li></ol><h2 id="2-4-索引优化"><a href="#2-4-索引优化" class="headerlink" title="2.4 索引优化"></a>2.4 索引优化</h2><h3 id="2-4-1-索引分析"><a href="#2-4-1-索引分析" class="headerlink" title="2.4.1 索引分析"></a>2.4.1 索引分析</h3><h4 id="2-4-1-1-单表"><a href="#2-4-1-1-单表" class="headerlink" title="2.4.1.1 单表"></a>2.4.1.1 单表</h4><ol><li><p>建表</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>article<span class="token punctuation">`</span>
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span>          <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>author_id<span class="token punctuation">`</span>   <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>category_id<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>views<span class="token punctuation">`</span>       <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>comments<span class="token punctuation">`</span>    <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>title<span class="token punctuation">`</span>       <span class="token keyword">VARBINARY</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>   <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>content<span class="token punctuation">`</span>     <span class="token keyword">TEXT</span>             <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>article<span class="token punctuation">`</span><span class="token punctuation">(</span>author_id<span class="token punctuation">,</span> category_id<span class="token punctuation">,</span> views<span class="token punctuation">,</span> comments<span class="token punctuation">,</span> title<span class="token punctuation">,</span> content<span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>查看</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">INDEX</span> <span class="token keyword">FROM</span> article<span class="token punctuation">;</span>

<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> author_id <span class="token keyword">FROM</span> article <span class="token keyword">WHERE</span> category_id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">AND</span> comments <span class="token operator">></span> <span class="token number">1</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> views <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">1</span><span class="token punctuation">;</span></code></pre><ul><li>type 为 all</li><li>extra出现了 Using filesort</li></ul></li><li><p>优化1</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_article_ccv <span class="token keyword">ON</span> article<span class="token punctuation">(</span>category_id<span class="token punctuation">,</span>comments<span class="token punctuation">,</span>views<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li>type为 range</li><li>extra 仍然有 Using filesort</li><li>原因：<ul><li>先category_id，再排comments，最后排views</li><li><code>commits&gt;1</code> 为范围，索引失效</li><li>comments位于中间，无法利用索引检索views，即range类型查询字段后面索引无效</li></ul></li></ul></li><li><p>优化2</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_article_ccv <span class="token keyword">ON</span> article<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_article_cv <span class="token keyword">ON</span> article<span class="token punctuation">(</span>category_id<span class="token punctuation">,</span> views<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li>此时type为ref</li><li>extra中不再有Using filesort</li></ul></li></ol><h4 id="2-4-1-2-两表"><a href="#2-4-1-2-两表" class="headerlink" title="2.4.1.2 两表"></a>2.4.1.2 两表</h4><ol><li><p>建表</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>class<span class="token punctuation">`</span>
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span>   <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>card<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>book<span class="token punctuation">`</span>
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>bookid<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>card<span class="token punctuation">`</span>   <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>两表查询</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> class <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> class<span class="token punctuation">.</span>card <span class="token operator">=</span> book<span class="token punctuation">.</span>card<span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+----+-------------+-------+------+------+
| id | select_type | table | type | rows |
+----+-------------+-------+------+------+
|  1 | SIMPLE      | class | ALL  |   20 |
|  1 | SIMPLE      | book  | ALL  |   20 |
+----+-------------+-------+------+------+</code></pre><ul><li>type为 ALL</li><li>rows共40条</li></ul></li><li><p>左表加索引</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> class <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> idx_class_card<span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+----+-------------+-------+-------+------+
| id | select_type | table | type  | rows |
+----+-------------+-------+-------+------+
|  1 | SIMPLE      | class | index |   20 |
|  1 | SIMPLE      | book  | ALL   |   20 |
+----+-------------+-------+-------+------+</code></pre></li><li><p>左表加索引</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_class_card <span class="token keyword">ON</span> class<span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> book <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> idx_book_card<span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+----+-------------+-------+------+------+
| id | select_type | table | type | rows |
+----+-------------+-------+------+------+
|  1 | SIMPLE      | class | ALL  |   20 |
|  1 | SIMPLE      | book  | ref  |    1 |
+----+-------------+-------+------+------+</code></pre></li></ol><h4 id="2-4-1-3-三表"><a href="#2-4-1-3-三表" class="headerlink" title="2.4.1.3 三表"></a>2.4.1.3 三表</h4><ol><li><p>建表</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>phone<span class="token punctuation">`</span>
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>phoneid<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>card<span class="token punctuation">`</span>    <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>三表查询</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> class c <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> book b <span class="token keyword">ON</span> c<span class="token punctuation">.</span>card <span class="token operator">=</span> b<span class="token punctuation">.</span>card <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> phone p <span class="token keyword">ON</span> b<span class="token punctuation">.</span>card <span class="token operator">=</span> p<span class="token punctuation">.</span>card<span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+----+-------------+-------+------+------+
| id | select_type | table | type | rows |
+----+-------------+-------+------+------+
|  1 | SIMPLE      | c     | ALL  |   20 |
|  1 | SIMPLE      | b     | ALL  |   20 |
|  1 | SIMPLE      | p     | ALL  |   20 |
+----+-------------+-------+------+------+</code></pre></li><li><p>建索引</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> book <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> idx_book_card<span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> phone <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> idx_phone_card<span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+----+-------------+-------+------+------+
| id | select_type | table | type | rows |
+----+-------------+-------+------+------+
|  1 | SIMPLE      | c     | ALL  |   20 |
|  1 | SIMPLE      | b     | ref  |    1 |
|  1 | SIMPLE      | p     | ref  |    1 |
+----+-------------+-------+------+------+</code></pre></li></ol><h4 id="2-4-1-4-结论"><a href="#2-4-1-4-结论" class="headerlink" title="2.4.1.4 结论"></a>2.4.1.4 结论</h4><ol><li>尽可能减少Join语句中的NestedLoop的循环总次数：永远用小的结果集驱动大的结果集</li><li>优先优化NestedLoop的内层循环</li><li>保证Join语句中被驱动表上Join条件字段已经被索引</li><li>当无法保证被驱动表的Join条件字段被索引且内存资源充足的前提下，不要太吝惜JoinBuffer的设置</li></ol><h3 id="2-4-2-索引失效"><a href="#2-4-2-索引失效" class="headerlink" title="2.4.2 索引失效"></a>2.4.2 索引失效</h3><ol><li><p>建表</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> staffs
<span class="token punctuation">(</span>
    id         <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span>     <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'姓名'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>age<span class="token punctuation">`</span>      <span class="token keyword">INT</span>         <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span> <span class="token keyword">COMMENT</span> <span class="token string">'年龄'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>pos<span class="token punctuation">`</span>      <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'职位'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>add_time<span class="token punctuation">`</span> <span class="token keyword">TIMESTAMP</span>   <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'入职时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">CHARSET</span> utf8 <span class="token keyword">COMMENT</span> <span class="token string">'员工记录表'</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> staffs<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span> age<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> add_time<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'z3'</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token string">'manager'</span><span class="token punctuation">,</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> staffs<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span> age<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> add_time<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'July'</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token string">'dev'</span><span class="token punctuation">,</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> staffs<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span> age<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> add_time<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2000'</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token string">'dev'</span><span class="token punctuation">,</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>添加索引</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> staffs <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> idx_staffs_nameAgePos<span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> pos<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>索引失效案例</p><ul><li><p>全值匹配：此时有效</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> staffs <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'July'</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> staffs <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'July'</span> <span class="token operator">AND</span> age <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> staffs <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'July'</span> <span class="token operator">AND</span> age <span class="token operator">=</span> <span class="token number">23</span> <span class="token operator">AND</span> pos<span class="token operator">=</span><span class="token string">'dev'</span><span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+----+-------------+--------+------------+------+
| id | select_type | table  | partitions | type |
+----+-------------+--------+------------+------+
|  1 | SIMPLE      | staffs | NULL       | ref  |
+----+-------------+--------+------------+------+</code></pre></li><li><p>最左前法则：如果索引了多列，要遵循最左前法则，查询从索引的最左前列开始且不跳过索引中的列</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> staffs <span class="token keyword">WHERE</span> age <span class="token operator">=</span> <span class="token number">23</span> <span class="token operator">AND</span> pos<span class="token operator">=</span><span class="token string">'dev'</span><span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+----+-------------+--------+------------+------+---------+
| id | select_type | table  | partitions | type | key_len |
+----+-------------+--------+------------+------+---------+
|  1 | SIMPLE      | staffs | NULL       | ref  | 74      |
+----+-------------+--------+------------+------+---------+</code></pre></li><li><p>不在索引列上做任何操作（计算、函数、类型转换），会导致索引失效而转向全表扫描</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> staffs <span class="token keyword">WHERE</span> <span class="token keyword">left</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token string">'July'</span><span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+----+-------------+--------+------------+------+
| id | select_type | table  | partitions | type |
+----+-------------+--------+------------+------+
|  1 | SIMPLE      | staffs | NULL       | ALL  |
+----+-------------+--------+------------+------+</code></pre></li><li><p>存储引擎不能使用索引中范围条件右边的列，即 “范围之后全失效”</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> staffs <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'July'</span> <span class="token operator">AND</span> age <span class="token operator">></span> <span class="token number">22</span> <span class="token operator">AND</span> pos<span class="token operator">=</span><span class="token string">'dev'</span><span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+----+-------------+--------+------------+-------+
| id | select_type | table  | partitions | type  |
+----+-------------+--------+------------+-------+
|  1 | SIMPLE      | staffs | NULL       | range |
+----+-------------+--------+------------+-------+</code></pre></li><li><p>尽量使用覆盖索引（索引列和查询列一致），减少 <code>select *</code></p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> pos <span class="token keyword">FROM</span> staffs <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'July'</span> <span class="token operator">AND</span> age <span class="token operator">=</span> <span class="token number">23</span> <span class="token operator">AND</span> pos<span class="token operator">=</span><span class="token string">'dev'</span><span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+----+-------------+--------+------------+------+-------------+
| id | select_type | table  | partitions | type | Extra       |
+----+-------------+--------+------------+------+-------------+
|  1 | SIMPLE      | staffs | NULL       | ref  | Using index |
+----+-------------+--------+------------+------+-------------+</code></pre></li><li><p>使用不等于（!=或 &lt;&gt;）的时候无法使用索引，会导致全表扫描</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> staffs <span class="token keyword">WHERE</span> name<span class="token operator">!=</span><span class="token string">'July'</span><span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+----+-------------+--------+------------+------+
| id | select_type | table  | partitions | type |
+----+-------------+--------+------------+------+
|  1 | SIMPLE      | staffs | NULL       | ALL  |
+----+-------------+--------+------------+------+</code></pre></li><li><p>is null，is not null也无法使用索引</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> staffs <span class="token keyword">WHERE</span> name <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+----+-------------+--------+------------+
| id | select_type | table  | partitions |
+----+-------------+--------+------------+
|  1 | SIMPLE      | staffs | NULL       |
+----+-------------+--------+------------+</code></pre></li><li><p>like 以通配符开头也会导致索引失效（结尾不会）</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> staffs <span class="token keyword">WHERE</span> name <span class="token operator">like</span> <span class="token string">'%July'</span><span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+----+-------------+--------+------------+------+
| id | select_type | table  | partitions | type |
+----+-------------+--------+------------+------+
|  1 | SIMPLE      | staffs | NULL       | ALL  |
+----+-------------+--------+------------+------+</code></pre><ul><li>可以通过覆盖索引解决</li></ul></li><li><p>字符串不加单引号会导致索引失效</p><p>不加单引号：发生了自动类型转换</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> staffs <span class="token keyword">WHERE</span> name <span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+----+-------------+--------+------------+------+
| id | select_type | table  | partitions | type |
+----+-------------+--------+------------+------+
|  1 | SIMPLE      | staffs | NULL       | ALL  |
+----+-------------+--------+------------+------+</code></pre><p>加单引号</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> staffs <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">'2000'</span><span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+----+-------------+--------+------------+------+
| id | select_type | table  | partitions | type |
+----+-------------+--------+------------+------+
|  1 | SIMPLE      | staffs | NULL       | ref  |
+----+-------------+--------+------------+------+</code></pre></li><li><p>少用or，使用or来连接时索引会失效</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> staffs <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'July'</span> <span class="token operator">OR</span> age <span class="token operator">=</span> <span class="token number">23</span><span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+----+-------------+--------+------------+------+
| id | select_type | table  | partitions | type |
+----+-------------+--------+------------+------+
|  1 | SIMPLE      | staffs | NULL       | ALL  |
+----+-------------+--------+------------+------+ </code></pre></li></ul></li></ol></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/MySQL/">MySQL</a> <a class="hover-with-bg" href="/categories/MySQL/MySQL%E9%AB%98%E7%BA%A7/">MySQL高级</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/mysql/">mysql</a></div></div><div class="post-prevnext row"><article class="post-prev col-6"><a href="/posts/6fb1e01/"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Chapter3 查询截取分析</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/posts/ac9f6c57/"><span class="hidden-mobile">Chapter1 前言</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><div class="disqus" style="width:100%"><div id="disqus_thread"></div><script>function loadDisqus(){addCssLink("https://cdn.jsdelivr.net/npm/disqusjs@1.0/dist/disqusjs.css"),addScript("https://cdn.jsdelivr.net/npm/disqusjs@1.0/dist/disqus.js",(function(){new DisqusJS({shortname:"Jacob",apikey:""})}))}waitElementVisible("disqus_thread",loadDisqus)</script><noscript>Please enable JavaScript to view the <a target="_blank" href="https://disqus.com/?ref_noscript" rel="nofollow noopener noopener">comments powered by Disqus.</a></noscript></div></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div id="tocbot"></div></div></div></div></div></main><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><footer class="mt-5"><div class="text-center py-3"><div><a href="https://github.com/" target="_blank" rel="nofollow noopener"><span>Github</span></a> <i class="iconfont icon-love"></i> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a></div><div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div><div><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script>var now=new Date;function createtime(){var n=new Date("10/06/2020 00:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="本站安全运行&nbsp"+dnum+"&nbsp天",document.getElementById("times").innerHTML=hnum+"&nbsp小时&nbsp"+mnum+"&nbsp分&nbsp"+snum+"&nbsp秒"}setInterval("createtime()",250)</script></div></div></footer><script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/main.js"></script><script src="/js/lazyload.js"></script><script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script><script src="/js/clipboard-use.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js"></script><script>$(document).ready((function(){var t=$("#board-ctn").offset().top;tocbot.init({tocSelector:"#tocbot",contentSelector:"#post-body",headingSelector:"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:3,scrollSmooth:!0,headingsOffset:-t}),$(".toc-list-item").length>0&&$("#toc").css("visibility","visible")}))</script><script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script><script>var typed=new Typed("#subtitle",{strings:["  ","Chapter2 索引优化&nbsp;"],cursorChar:"|",typeSpeed:90,loop:!0});typed.stop(),$(document).ready((function(){$(".typed-cursor").addClass("h2"),typed.start()}))</script><script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script><script>anchors.options={placement:"right",visible:"hover"};var el="h1,h2,h3,h4,h5,h6".split(","),res=[];for(item of el)res.push(".markdown-body > "+item);anchors.add(res.join(", "))</script><script src="/js/local-search.js"></script><script>var path="/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){searchFunc(path,"local-search-input","local-search-result"),this.onclick=null}</script><script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><script>$("#post img:not(.no-zoom img, img[no-zoom]), img[zoom]").each((function(){var t=document.createElement("a");$(t).attr("data-fancybox","images"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)}))</script></body></html>