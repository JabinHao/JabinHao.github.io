<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png"><link rel="icon" type="image/png" href="/img/site.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content="Jipeng Hao 的个人博客"><meta name="author" content="Martentite"><meta name="keywords" content="java, python, blog"><title>Chapter8后台管理 — 权限控制 - 山那边的小木屋</title><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/prism/1.21.0/themes/prism-okaidia.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="山那边的小木屋" type="application/atom+xml">
</head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>Jacob</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner intro-2" id="background" parallax="true" style="background:url(/img/post/banner/mandao.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="container page-header text-center fade-in-up"><span class="h2" id="subtitle"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Martentite </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-01-12 16:50" pubdate>2021年1月12日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 3.1k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 48 分钟</span></div></div></div></div></div></header><main><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="container nopadding-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto" id="post"><h1 style="display:none">Chapter8后台管理 — 权限控制</h1><div class="markdown-body" id="post-body"><h2 id="8-1-项目中加入-SpringSecurity-环境"><a href="#8-1-项目中加入-SpringSecurity-环境" class="headerlink" title="8.1 项目中加入 SpringSecurity 环境"></a>8.1 项目中加入 SpringSecurity 环境</h2><h3 id="8-1-1-依赖"><a href="#8-1-1-依赖" class="headerlink" title="8.1.1 依赖"></a>8.1.1 依赖</h3><ol><li><p>父工程中版本管理</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!-- 声明属性， 对 Spring 的版本进行统一管理 --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring.version</span><span class="token punctuation">></span></span>5.2.11.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring.version</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!-- 声明属性， 对 SpringSecurity 的版本进行统一管理 --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring.security.version</span><span class="token punctuation">></span></span>5.4.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring.security.version</span><span class="token punctuation">></span></span>
    ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span></code></pre><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!-- SpringSecurity 对 Web 应用进行权限管理 --></span>
<span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.security/spring-security-web --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-security-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spring.security.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!-- SpringSecurity 配置 --></span>
<span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.security/spring-security-config --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-security-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spring.security.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!-- SpringSecurity 标签库 --></span>
<span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.security/spring-security-taglibs --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-security-taglibs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spring.security.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre></li><li><p>component模块引入依赖</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-security-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-security-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-security-taglibs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre></li></ol><h3 id="8-1-2-配置-DelegatingFilterProxy"><a href="#8-1-2-配置-DelegatingFilterProxy" class="headerlink" title="8.1.2 配置 DelegatingFilterProxy"></a>8.1.2 配置 DelegatingFilterProxy</h3><ol><li>webui模块 web.xml</li><li>代码：<pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!-- SpringSecurity 的配置，filter-name必须是springSecurityFilterChain --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">></span></span>springSecurityFilterChain<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-class</span><span class="token punctuation">></span></span>org.springframework.web.filter.DelegatingFilterProxy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-class</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-mapping</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">></span></span>springSecurityFilterChain<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>/*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-mapping</span><span class="token punctuation">></span></span></code></pre></li></ol><h3 id="8-1-3-创建基于注解的配置类"><a href="#8-1-3-创建基于注解的配置类" class="headerlink" title="8.1.3 创建基于注解的配置类"></a>8.1.3 创建基于注解的配置类</h3><ol><li>component模块下com/atguigu/crowd/mvc/config包中新建配置类WebAppSecurityConfig.java</li><li>代码<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span> <span class="token comment">// 当前类为配置类</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>  <span class="token comment">// 启用web环境下权限控制功能</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebAppSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span></code></pre></li></ol><h2 id="8-2-SpringSecurity-与-SSM-框架整合"><a href="#8-2-SpringSecurity-与-SSM-框架整合" class="headerlink" title="8.2 SpringSecurity 与 SSM 框架整合"></a>8.2 SpringSecurity 与 SSM 框架整合</h2><h3 id="8-2-1-分析"><a href="#8-2-1-分析" class="headerlink" title="8.2.1 分析"></a>8.2.1 分析</h3><ol><li><p>三大组件启动顺序</p><ul><li>ContextLoaderListener 初始化， 创建 Spring 的 IOC 容器</li><li>DelegatingFilterProxy 初始化， 查找 IOC 容器、 查找 bean</li><li>DispatcherServlet 初始化， 创建 SpringMVC 的 IOC 容器</li></ul></li><li><p>把 WebAppSecurityConfig 放到哪个 IOC 容器中</p><ul><li>Spring的IOC：service、mapper</li><li>SpringMVC的IOC容器：controller（handler）</li><li>了让 SpringSecurity 能够针对浏览器请求进行权限控制， 需要让SpringMVC 来扫描 WebAppSecurityConfig 类</li></ul></li><li><p>DelegatingFilterProxy 查找 IOC 容器然后查找 bean 的工作机制<br><img src="https://raw.githubusercontent.com/JabinHao/mihs/master/blog/crowd_funding/8-2-1.png" srcset="/img/loading.gif"></p></li></ol><h3 id="8-2-2-解决方案一"><a href="#8-2-2-解决方案一" class="headerlink" title="8.2.2 解决方案一"></a>8.2.2 解决方案一</h3><ol><li>思路：把两个 IOC 容器合二为一， 不使用 ContextLoaderListener， 让 DispatcherServlet 加载所有 Spring 配置文件</li></ol><ul><li>DelegatingFilterProxy 在初始化时查找 IOC 容器， 找不到， 放弃。</li><li>第一次请求时再次查找。</li><li>找到 SpringMVC 的 IOC 容器。</li><li>从这个 IOC 容器中找到所需要的 bean</li></ul><ol start="2"><li>缺陷： 会破坏现有程序的结构。 原本是 ContextLoaderListener 和 DispatcherServlet两个组件创建两个 IOC 容器， 现在改成只有一个</li><li>具体操作<ul><li>web.xml中注释掉contextConfigLocation的配置</li><li>springDispatcherServlet的初始化参数 <code>param-value</code> 改为 <code>spring-*.xml</code></li></ul></li></ol><h3 id="8-2-3-解决方案二-—-修改源码"><a href="#8-2-3-解决方案二-—-修改源码" class="headerlink" title="8.2.3 解决方案二 — 修改源码"></a>8.2.3 解决方案二 — 修改源码</h3><ol><li><p>思路：修改 DelegatingFilterProxy 的源码，使得</p><ul><li>初始化时直接跳过查找 IOC 容器的环节</li><li>第一次请求的时候直接找 SpringMVC 的 IOC 容器</li></ul></li><li><p>操作</p><ul><li>component模块java目录下新建 org.springframework.web.filter 包</li><li>新建 DelegatingFilterProxy 类，将原来的DelegatingFilterProxy类内容复制过来</li><li>修改 initFilterBean 方法，初始化时跳过查找 IOC 容器的环节<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initFilterBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegateMonitor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// If no target bean name specified, use filter name.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>targetBeanName <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>targetBeanName <span class="token operator">=</span> <span class="token function">getFilterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">// Fetch Spring root application context and initialize the delegate early,</span>
            <span class="token comment">// if possible. If the root application context will be started after this</span>
            <span class="token comment">// filter proxy, we'll have to resort to lazy initialization.</span>

            <span class="token comment">// 修改这里</span>
            <span class="token comment">/*WebApplicationContext wac = findWebApplicationContext();
            if (wac != null) &#123;
                this.delegate = initDelegate(wac);
            &#125;*/</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre></li><li>修改 <code>doFilter</code> 方法<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// Lazily initialize the delegate if necessary.</span>
    <span class="token class-name">Filter</span> delegateToUse <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>delegateToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegateMonitor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            delegateToUse <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>delegateToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 把原来的查找 IOC 容器的代码注释掉</span>
                <span class="token comment">// WebApplicationContext wac = findWebApplicationContext();</span>
                <span class="token comment">// 按我们自己的需要重新编写</span>
                <span class="token comment">// 1.获取 ServletContext 对象</span>
                <span class="token class-name">ServletContext</span> sc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 2.拼接 SpringMVC 将 IOC 容器存入 ServletContext 域的时候使用的属性名</span>
                <span class="token class-name">String</span> servletName <span class="token operator">=</span> <span class="token string">"springDispatcherServlet"</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> attrName <span class="token operator">=</span> <span class="token class-name">FrameworkServlet</span><span class="token punctuation">.</span>SERVLET_CONTEXT_PREFIX <span class="token operator">+</span> servletName<span class="token punctuation">;</span>
                <span class="token comment">// 3.根据 attrName 从 ServletContext 域中获取 IOC 容器对象</span>
                <span class="token class-name">WebApplicationContext</span> wac <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">WebApplicationContext</span><span class="token punctuation">)</span>sc<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>attrName<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>wac <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"No WebApplicationContext found: "</span> <span class="token operator">+</span>
                            <span class="token string">"no ContextLoaderListener or DispatcherServlet registered?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                delegateToUse <span class="token operator">=</span> <span class="token function">initDelegate</span><span class="token punctuation">(</span>wac<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> delegateToUse<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Let the delegate perform the actual doFilter operation.</span>
    <span class="token function">invokeDelegate</span><span class="token punctuation">(</span>delegateToUse<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> filterChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre></li></ul></li></ol><h2 id="8-3-配置-SpringSecurity"><a href="#8-3-配置-SpringSecurity" class="headerlink" title="8.3 配置 SpringSecurity"></a>8.3 配置 SpringSecurity</h2><h3 id="8-3-1-放行登录页和静态资源"><a href="#8-3-1-放行登录页和静态资源" class="headerlink" title="8.3.1 放行登录页和静态资源"></a>8.3.1 放行登录页和静态资源</h3><ol><li>在 SpringSecurity 的配置类 WebAppSecurityConfig 中重写 configure(HttpSecuritysecurity)方法并设置</li><li>代码<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> security<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>

    security
            <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                            <span class="token comment">// 对请求进行授权</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/admin/to/login.do"</span><span class="token punctuation">)</span>  <span class="token comment">// 针对登录页进行设置</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/bootstrap/**"</span><span class="token punctuation">)</span>       <span class="token comment">// 针对静态资源进行设置， 无条件访问</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/css/**"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/fonts/**"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/img/**"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/jquery/**"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/js/**"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/layer/**"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/script/**"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/ztree/**"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre></li></ol><h3 id="8-3-2-提交登录表单做内存认证"><a href="#8-3-2-提交登录表单做内存认证" class="headerlink" title="8.3.2 提交登录表单做内存认证"></a>8.3.2 提交登录表单做内存认证</h3><ol><li>思路<br><img src="https://raw.githubusercontent.com/JabinHao/mihs/master/blog/crowd_funding/8-3-2.png" srcset="/img/loading.gif"></li><li>修改 admin-login.jsp<pre class="language-jsp" data-language="jsp"><code class="language-jsp">&lt;form action&#x3D;&quot;security&#x2F;do&#x2F;login.do&quot; method&#x3D;&quot;post&quot; class&#x3D;&quot;form-signin&quot; role&#x3D;&quot;form&quot;&gt;
    &lt;h2 class&#x3D;&quot;form-signin-heading&quot;&gt;&lt;i class&#x3D;&quot;glyphicon glyphicon-log-in&quot;&gt;&lt;&#x2F;i&gt;管理员登录&lt;&#x2F;h2&gt;
    &lt;p&gt;$&#123;requestScope.exception.message&#125;&lt;&#x2F;p&gt;
    &lt;p&gt;$&#123;SPRING_SECURITY_LAST_EXCEPTION.message &#125;&lt;&#x2F;p&gt;</code></pre></li><li>SpringSecurity 配置<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> security<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>

    security
            <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                            <span class="token comment">// 对请求进行授权</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/admin/to/login.do"</span><span class="token punctuation">)</span>  <span class="token comment">// 针对登录页进行设置</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/bootstrap/**"</span><span class="token punctuation">)</span>       <span class="token comment">// 针对静态资源进行设置， 无条件访问</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/css/**"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/fonts/**"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/img/**"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/jquery/**"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/js/**"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/layer/**"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/script/**"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/ztree/**"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                               <span class="token comment">// 关闭防跨站请求伪造</span>
            <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                    <span class="token comment">// 开启表单登录功能</span>
            <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/admin/to/login.do"</span><span class="token punctuation">)</span>                <span class="token comment">// 指定登录页面</span>
            <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/security/do/login.do"</span><span class="token punctuation">)</span>    <span class="token comment">// 指定处理登录请求的地址</span>
            <span class="token punctuation">.</span><span class="token function">defaultSuccessUrl</span><span class="token punctuation">(</span><span class="token string">"/admin/to/main.do"</span><span class="token punctuation">)</span>         <span class="token comment">// 指定登录成功后前往的地址</span>
            <span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">"loginAcct"</span><span class="token punctuation">)</span>                 <span class="token comment">// 账号的请求参数名称</span>
            <span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">"userPswd"</span><span class="token punctuation">)</span>                  <span class="token comment">// 密码的请求参数名称</span>
            <span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre></li><li>关闭自定义的拦截器：spring-web-mvc.xml<pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--    使用SpringSecurity后，当前自定义的登录拦截器不再使用
&amp;lt;!&amp;ndash;注册拦截器&amp;ndash;&amp;gt;
&lt;mvc:interceptors>
    &lt;mvc:interceptor>
        &amp;lt;!&amp;ndash;要拦截的路径&amp;ndash;&amp;gt;
        &lt;mvc:mapping path="/**"/>
        &amp;lt;!&amp;ndash;不拦截的资源&amp;ndash;&amp;gt;
        &lt;mvc:exclude-mapping path="/admin/to/login.do"/>
        &lt;mvc:exclude-mapping path="/admin/do/login.do"/>
        &lt;mvc:exclude-mapping path="/admin/do/logout.do"/>
        &lt;mvc:exclude-mapping path="/test/**"/>
        &amp;lt;!&amp;ndash;配置拦截器类&amp;ndash;&amp;gt;
        &lt;bean class="com.atguigu.crowd.mvc.interceptor.LoginInterceptor"/>
    &lt;/mvc:interceptor>
&lt;/mvc:interceptors>
--></span></code></pre></li></ol><h3 id="8-3-3-退出登录"><a href="#8-3-3-退出登录" class="headerlink" title="8.3.3 退出登录"></a>8.3.3 退出登录</h3><ol><li><p>前端代码：</p><pre class="language-jsp" data-language="jsp"><code class="language-jsp">&lt;li&gt;&lt;a href&#x3D;&quot;security&#x2F;do&#x2F;logout.do&quot;&gt;&lt;i class&#x3D;&quot;glyphicon glyphicon-off&quot;&gt;&lt;&#x2F;i&gt; 退出系统&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;</code></pre></li><li><p>后端代码</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                       <span class="token comment">// 退出登录功能</span>
<span class="token punctuation">.</span><span class="token function">logoutUrl</span><span class="token punctuation">(</span><span class="token string">"/security/do/logout.do"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">logoutSuccessUrl</span><span class="token punctuation">(</span><span class="token string">"/security/do/login.do"</span><span class="token punctuation">)</span>
<span class="token punctuation">;</span></code></pre></li></ol><h3 id="8-3-4-把内存登录改成数据库登录"><a href="#8-3-4-把内存登录改成数据库登录" class="headerlink" title="8.3.4 把内存登录改成数据库登录"></a>8.3.4 把内存登录改成数据库登录</h3><ol><li><p>思路<br><img src="https://raw.githubusercontent.com/JabinHao/mihs/master/blog/crowd_funding/20210113011711.png" srcset="/img/loading.gif"></p></li><li><p>根据 adminId 查询已分配的角色（可以用之前的方法）：</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// RoleService</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Role</span><span class="token punctuation">></span></span> <span class="token function">getAssignedRole</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> adminId<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>根据 adminId 查询已分配权限</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// AuthService</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getAssignedAuthNameByAdminId</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> adminId<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// AuthServiceImpl</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getAssignedAuthNameByAdminId</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> adminId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

     <span class="token keyword">return</span> authMapper<span class="token punctuation">.</span><span class="token function">selectAssignedAuthNameByAdminId</span><span class="token punctuation">(</span>adminId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// AuthMapper</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">selectAssignedAuthNameByAdminId</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> adminId<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!-- AuthMapper.xml --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectAssignedAuthNameByAdminId<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>string<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    select distinct t_auth.name
    from t_auth
    left join inner_role_auth on t_auth.id=inner_role_auth.auth_id
    left join inner_admin_role iar on inner_role_auth.role_id = iar.role_id
    where iar.admin_id=#&#123;adminId&#125; AND t_auth.name != "" AND t_auth.name IS NOT NULL;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span></code></pre></li><li><p>创建 SecurityAdmin 类</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// config包下</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityAdmin</span> <span class="token keyword">extends</span> <span class="token class-name">User</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token comment">// 原始的 Admin 对象， 包含 Admin 对象的全部属性</span>
    <span class="token keyword">private</span> <span class="token class-name">Admin</span> originalAdmin<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SecurityAdmin</span><span class="token punctuation">(</span><span class="token class-name">Admin</span> originalAdmin<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">></span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>originalAdmin<span class="token punctuation">.</span><span class="token function">getLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> originalAdmin<span class="token punctuation">.</span><span class="token function">getUserPswd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>originalAdmin <span class="token operator">=</span> originalAdmin<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 对外提供的获取原始 Admin 对象的 getXxx()方法</span>
    <span class="token keyword">public</span> <span class="token class-name">Admin</span> <span class="token function">getOriginalAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> originalAdmin<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre></li><li><p>根据账号查询 Admin</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// AdminService</span>
<span class="token class-name">Admin</span> <span class="token function">getAdminByLoginAcct</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Admin</span> <span class="token function">getAdminByLoginAcct</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">AdminExample</span> example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AdminExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Criteria</span> criteria <span class="token operator">=</span> example<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    criteria<span class="token punctuation">.</span><span class="token function">andLoginEqualTo</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> adminMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre></li><li><p>创建 <code>UserDetailsService</code> 实现类</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// config包下</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CrowdUserDetailsService</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AdminService</span> adminService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RoleService</span> roleService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthService</span> authService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// 1.根据账号名称查询Admin对象</span>
        <span class="token class-name">Admin</span> admin <span class="token operator">=</span> adminService<span class="token punctuation">.</span><span class="token function">getAdminByLoginAcct</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2.获取adminId</span>
        <span class="token class-name">Integer</span> adminId <span class="token operator">=</span> admin<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.根据adminId查询角色信息</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Role</span><span class="token punctuation">></span></span> assignedRoleList <span class="token operator">=</span> roleService<span class="token punctuation">.</span><span class="token function">getAssignedRole</span><span class="token punctuation">(</span>adminId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4.根据 adminId 查询权限信息</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> authNameList <span class="token operator">=</span> authService<span class="token punctuation">.</span><span class="token function">getAssignedAuthNameByAdminId</span><span class="token punctuation">(</span>adminId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5.创建集合用来存储 GrantedAuthority</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">></span></span> authorities <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 6.遍历 assignedRoleList 存入角色信息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Role</span> role<span class="token operator">:</span>assignedRoleList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token class-name">String</span> roleName <span class="token operator">=</span> <span class="token string">"ROLE_"</span><span class="token operator">+</span>role<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">SimpleGrantedAuthority</span> simpleGrantedAuthority <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">(</span>roleName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            authorities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>simpleGrantedAuthority<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 7.遍历 authNameList 存入权限信息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> authName<span class="token operator">:</span> authNameList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token class-name">SimpleGrantedAuthority</span> simpleGrantedAuthority <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">(</span>authName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            authorities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>simpleGrantedAuthority<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 8.封装 SecurityAdmin 对象</span>
        <span class="token class-name">SecurityAdmin</span> securityAdmin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecurityAdmin</span><span class="token punctuation">(</span>admin<span class="token punctuation">,</span> authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> securityAdmin<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre></li><li><p>在配置类中使用 UserDetailsService</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> builder<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>

    builder
            <span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token class-name">NoOpPasswordEncoder</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre></li></ol><h3 id="8-3-5-密码加密"><a href="#8-3-5-密码加密" class="headerlink" title="8.3.5 密码加密"></a>8.3.5 密码加密</h3><ol><li><p>修改 t_admin 表</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 修改t_admin表 密码长度</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> t_admin <span class="token keyword">MODIFY</span> user_pswd <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></code></pre></li><li><p>spring-persist-tx.xml 文件中配置bean</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!-- 配置 BCryptPasswordEncoder --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>passwordEncoder<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></code></pre></li><li><p>配置类</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">PasswordEncoder</span> passwordEncoder<span class="token punctuation">;</span>

<span class="token comment">// ....</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> builder<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>

    builder
            <span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span>passwordEncoder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre></li><li><p>修改 AdminServiceImpl</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">PasswordEncoder</span> passwordEncoder<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveAdmin</span><span class="token punctuation">(</span><span class="token class-name">Admin</span> admin<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 密码加密</span>
    <span class="token class-name">String</span> userPswd <span class="token operator">=</span> admin<span class="token punctuation">.</span><span class="token function">getUserPswd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    admin<span class="token punctuation">.</span><span class="token function">setUserPswd</span><span class="token punctuation">(</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>userPswd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ...</span></code></pre></li></ol><h3 id="8-3-6-在页面上显示用户昵称"><a href="#8-3-6-在页面上显示用户昵称" class="headerlink" title="8.3.6 在页面上显示用户昵称"></a>8.3.6 在页面上显示用户昵称</h3><ol><li>前端页面：include-nav.jsp<pre class="language-jsp" data-language="jsp"><code class="language-jsp">&lt;%@taglib prefix&#x3D;&quot;security&quot; uri&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;security&#x2F;tags&quot; %&gt;</code></pre><pre class="language-jsp" data-language="jsp"><code class="language-jsp">&lt;%--$&#123;sessionScope.loginAdmin.userName&#125;--%&gt;
&lt;security:authentication property&#x3D;&quot;principal.originalAdmin.userName&quot;&#x2F;&gt;</code></pre></li><li>SpringSecurity 处理完登录操作之后把登录成功的 User 对象以 principal 属性名存入了<code>UsernamePasswordAuthenticationToken</code> 对象</li></ol><h3 id="8-3-7-密码的擦除"><a href="#8-3-7-密码的擦除" class="headerlink" title="8.3.7 密码的擦除"></a>8.3.7 密码的擦除</h3><ol><li><p>SpringSecurity 是会自动把 User 对象中的密码部分擦除</p><pre class="language-java" data-language="java"><code class="language-java">   <span class="token comment">// User 源码，实现了 CredentialsContainer 接口中的eraseCredentials方法</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eraseCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre></li><li><p>我们创建 SecurityAdmin 对象扩展了 User 对象， User 对象中的密码被擦除了，但是原始 Admin 对象中的密码没有擦除</p></li><li><p>修改 SecurityAdmin，将原始 Admin 对象中的密码擦除</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">SecurityAdmin</span><span class="token punctuation">(</span><span class="token class-name">Admin</span> originalAdmin<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">></span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>originalAdmin<span class="token punctuation">.</span><span class="token function">getLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> originalAdmin<span class="token punctuation">.</span><span class="token function">getUserPswd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 给本类的 this.originalAdmin 赋值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>originalAdmin <span class="token operator">=</span> originalAdmin<span class="token punctuation">;</span>

    <span class="token comment">// 将原始 Admin 对象中的密码擦除，密码已经传给父类User构造器，因此这里擦除不影响</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>originalAdmin<span class="token punctuation">.</span><span class="token function">setUserPswd</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre></li></ol><h3 id="8-3-8-权限控制"><a href="#8-3-8-权限控制" class="headerlink" title="8.3.8 权限控制"></a>8.3.8 权限控制</h3><h4 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1. 准备工作"></a>1. 准备工作</h4><ol><li><p>修改 t_auth 表</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_auth<span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span>title<span class="token punctuation">,</span>category_id<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'user:save'</span><span class="token punctuation">,</span><span class="token string">'保存'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>管理员</p><ul><li>启动服务器，登录后 -&gt; 权限管理 -&gt; 用户维护</li><li>新增管理员 adminOperator、roleOperator</li></ul></li><li><p>分配角色</p><ul><li>为 adminOperator 分配 经理、经理操作者角色</li><li>为 roleOperator 分配 部长、部长操作者角色</li></ul></li><li><p>分配权限</p><ul><li>为经理操作者分配保存权限</li><li>为部长操作者分配删除权限</li></ul></li></ol><h4 id="2-测试"><a href="#2-测试" class="headerlink" title="2. 测试"></a>2. 测试</h4><ul><li>测试一<ul><li>要求：访问 Admin 分页功能时具备“经理” 角色</li><li>代码<pre class="language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/admin/get/page.do"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"经理"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                   <span class="token comment">// 其它任意请求</span>
<span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                <span class="token comment">// 认证登录后访问</span></code></pre></li></ul></li><li>测试二<ul><li>要求：访问 Role 的分页功能时具备“部长” 角色</li><li>代码<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// WebAppSecurityConfig</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 启用全局方法权限控制功能， 并且设置 prePostEnabled = true。 保证@PreAuthority、@PostAuthority、 @PreFilter、 @PostFilter 生效</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebAppSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">&#123;</span></code></pre><pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// RoleHandler</span>
<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasRole('部长')"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/role/get/page/info.do"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResultEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageInfo</span><span class="token punctuation">&lt;</span><span class="token class-name">Role</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">getPageInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pageNum"</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> pageNum<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pageSize"</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">"5"</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token class-name">String</span> keyword<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></code></pre></li><li>完善基于注解的异常映射：修改CrowdExceptionResolver.java的resolveAccessForbiddenException方法<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// 未登录异常</span>
<span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">resolveException</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> exception<span class="token punctuation">,</span>
                                     <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
                                     <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> viewName <span class="token operator">=</span> <span class="token string">"admin-login"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">commonResolve</span><span class="token punctuation">(</span>viewName<span class="token punctuation">,</span>exception<span class="token punctuation">,</span>request<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre></li><li>自定义403页面<pre class="language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                   <span class="token comment">// 其它任意请求</span>
<span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                <span class="token comment">// 认证登录后访问</span>
<span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">exceptionHandling</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">accessDeniedHandler</span><span class="token punctuation">(</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
    request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"exception"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token class-name">CrowdConstant</span><span class="token punctuation">.</span>MESSAGE_ACCESS_DENIED<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">getRequestDispatcher</span><span class="token punctuation">(</span><span class="token string">"/WEB-INF/system-error.jsp"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></code></pre></li></ul></li><li>测试三<ul><li>要求： 访问 Admin 保存功能时具备 user:save 权限</li><li>代码：AdminHandler<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAuthority('user:save')"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/admin/save.do"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">Admin</span> admin<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></code></pre></li></ul></li><li>测试 4<ul><li>要求： 访问 Admin 分页功能时具备“经理” 角色或“user:get” 权限二者之一</li><li>代码<pre class="language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/admin/get/page.do"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"hasRole('经理') OR hasAuthority('user:get')"</span><span class="token punctuation">)</span>
<span class="token comment">//.hasAuthority("user:get")</span></code></pre></li></ul></li></ul><h3 id="8-3-9-页面元素的权限控制"><a href="#8-3-9-页面元素的权限控制" class="headerlink" title="8.3.9 页面元素的权限控制"></a>8.3.9 页面元素的权限控制</h3><ol><li><p>说明</p><ul><li>页面上的局部元素， 根据访问控制规则进行控制</li><li>通过 <code>security:authorize</code> 标签进行控制</li></ul></li><li><p>代码</p><pre class="language-jsp" data-language="jsp"><code class="language-jsp">&lt;!-- admin-main.jsp --&gt;
&lt;security:authorize access&#x3D;&quot;hasRole(&#39;经理&#39;)&quot;&gt;
    &lt;div class&#x3D;&quot;col-xs-6 col-sm-3 placeholder&quot;&gt;
        &lt;img data-src&#x3D;&quot;holder.js&#x2F;200x200&#x2F;auto&#x2F;sky&quot; class&#x3D;&quot;img-responsive&quot; alt&#x3D;&quot;Generic placeholder thumbnail&quot;&gt;
        &lt;h4&gt;Label&lt;&#x2F;h4&gt;
        &lt;span class&#x3D;&quot;text-muted&quot;&gt;Something else&lt;&#x2F;span&gt;
    &lt;&#x2F;div&gt;
&lt;&#x2F;security:authorize&gt;</code></pre></li><li><p>修改源码</p><ul><li>新建 org.springframework.security.taglibs.authz.AbstractAuthorizeTag 类</li><li>复制原来的内容到该类中</li><li>修改：<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">SecurityExpressionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FilterInvocation</span><span class="token punctuation">></span></span> <span class="token function">getExpressionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ApplicationContext appContext = SecurityWebApplicationContextUtils.findRequiredWebApplicationContext(getServletContext());</span>

    <span class="token comment">// 1.获取 ServletContext 对象</span>
    <span class="token class-name">ServletContext</span> servletContext <span class="token operator">=</span> <span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2.拼接 SpringMVC 在 ServletContext 域中的属性名</span>
    <span class="token class-name">String</span> attrName <span class="token operator">=</span> <span class="token class-name">FrameworkServlet</span><span class="token punctuation">.</span>SERVLET_CONTEXT_PREFIX <span class="token operator">+</span> <span class="token string">"springDispatcherServlet"</span><span class="token punctuation">;</span>

    <span class="token comment">// 3.从 ServletContext 域中获取 IOC 容器对象</span>
    <span class="token class-name">ApplicationContext</span> appContext <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span><span class="token punctuation">)</span>servletContext<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>attrName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SecurityExpressionHandler</span><span class="token punctuation">></span></span> handlers <span class="token operator">=</span> appContext<span class="token punctuation">.</span><span class="token function">getBeansOfType</span><span class="token punctuation">(</span><span class="token class-name">SecurityExpressionHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li>效果：仅具有经理角色的用户能看到该组件</li></ul></li></ol></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/Java%E7%AC%94%E8%AE%B0/">Java笔记</a> <a class="hover-with-bg" href="/categories/Java%E7%AC%94%E8%AE%B0/%E9%A1%B9%E7%9B%AE/">项目</a> <a class="hover-with-bg" href="/categories/Java%E7%AC%94%E8%AE%B0/%E9%A1%B9%E7%9B%AE/%E5%B0%9A%E7%AD%B9%E7%BD%91/">尚筹网</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/java/">java</a> <a class="hover-with-bg" href="/tags/ssm/">ssm</a></div></div><div class="post-prevnext row"><article class="post-prev col-6"><a href="/posts/2582c489/"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Chapter9分布式 — SpringBoot快速入门</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/posts/3819e182/"><span class="hidden-mobile">Chapter7后台管理 — SpringSecurity</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><div class="disqus" style="width:100%"><div id="disqus_thread"></div><script>function loadDisqus(){addCssLink("https://cdn.jsdelivr.net/npm/disqusjs@1.0/dist/disqusjs.css"),addScript("https://cdn.jsdelivr.net/npm/disqusjs@1.0/dist/disqus.js",(function(){new DisqusJS({shortname:"Jacob",apikey:""})}))}waitElementVisible("disqus_thread",loadDisqus)</script><noscript>Please enable JavaScript to view the <a target="_blank" href="https://disqus.com/?ref_noscript" rel="nofollow noopener noopener">comments powered by Disqus.</a></noscript></div></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div id="tocbot"></div></div></div></div></div></main><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><footer class="mt-5"><div class="text-center py-3"><div><a href="https://github.com/" target="_blank" rel="nofollow noopener"><span>Github</span></a> <i class="iconfont icon-love"></i> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a></div><div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div><div><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script>var now=new Date;function createtime(){var n=new Date("10/06/2020 00:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="本站安全运行&nbsp"+dnum+"&nbsp天",document.getElementById("times").innerHTML=hnum+"&nbsp小时&nbsp"+mnum+"&nbsp分&nbsp"+snum+"&nbsp秒"}setInterval("createtime()",250)</script></div></div></footer><script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/main.js"></script><script src="/js/lazyload.js"></script><script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script><script src="/js/clipboard-use.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js"></script><script>$(document).ready((function(){var t=$("#board-ctn").offset().top;tocbot.init({tocSelector:"#tocbot",contentSelector:"#post-body",headingSelector:"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:3,scrollSmooth:!0,headingsOffset:-t}),$(".toc-list-item").length>0&&$("#toc").css("visibility","visible")}))</script><script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script><script>var typed=new Typed("#subtitle",{strings:["  ","Chapter8后台管理 — 权限控制&nbsp;"],cursorChar:"|",typeSpeed:90,loop:!0});typed.stop(),$(document).ready((function(){$(".typed-cursor").addClass("h2"),typed.start()}))</script><script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script><script>anchors.options={placement:"right",visible:"hover"};var el="h1,h2,h3,h4,h5,h6".split(","),res=[];for(item of el)res.push(".markdown-body > "+item);anchors.add(res.join(", "))</script><script src="/js/local-search.js"></script><script>var path="/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){searchFunc(path,"local-search-input","local-search-result"),this.onclick=null}</script><script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><script>$("#post img:not(.no-zoom img, img[no-zoom]), img[zoom]").each((function(){var t=document.createElement("a");$(t).attr("data-fancybox","images"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)}))</script></body></html>