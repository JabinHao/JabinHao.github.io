<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png"><link rel="icon" type="image/png" href="/img/site.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content="Jipeng Hao 的个人博客"><meta name="author" content="Martentite"><meta name="keywords" content="java, python, blog"><title>Chapter3 查询截取分析 - 山那边的小木屋</title><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/prism/1.21.0/themes/prism-okaidia.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="山那边的小木屋" type="application/atom+xml">
</head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>Jacob</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner intro-2" id="background" parallax="true" style="background:url(/img/post/banner/cat.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="container page-header text-center fade-in-up"><span class="h2" id="subtitle"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Martentite </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-02-08 02:11" pubdate>2021年2月8日 凌晨</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2.6k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 38 分钟</span></div></div></div></div></div></header><main><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="container nopadding-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto" id="post"><h1 style="display:none">Chapter3 查询截取分析</h1><div class="markdown-body" id="post-body"><h1 id="3-1-查询优化"><a href="#3-1-查询优化" class="headerlink" title="3.1 查询优化"></a>3.1 查询优化</h1><h2 id="3-1-1-小表驱动大表"><a href="#3-1-1-小表驱动大表" class="headerlink" title="3.1.1 小表驱动大表"></a>3.1.1 小表驱动大表</h2><ol><li><p>即用小的数据集驱动大的数据集，减少了连接次数</p></li><li><p>in与exists</p><ul><li><p>in</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> A <span class="token keyword">where</span> id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> id <span class="token keyword">from</span> B<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 相当于：</span>
<span class="token keyword">for</span> <span class="token keyword">select</span> id <span class="token keyword">from</span> B
<span class="token keyword">for</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> A <span class="token keyword">where</span> A<span class="token punctuation">.</span>id<span class="token operator">=</span>B<span class="token punctuation">.</span>id</code></pre></li><li><p>exists</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> A <span class="token keyword">where</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span> <span class="token keyword">from</span> B <span class="token keyword">where</span> B<span class="token punctuation">.</span>id <span class="token operator">=</span> A<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
<span class="token comment"># 等价于</span>
<span class="token keyword">for</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> A
<span class="token keyword">for</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> B <span class="token keyword">where</span> B<span class="token punctuation">.</span>id <span class="token operator">=</span> A<span class="token punctuation">.</span>id</code></pre></li><li><p>当B表数据集小于A表时用in优于exists，反之exists由于in</p></li></ul></li></ol><h2 id="3-1-2-order-by关键字优化"><a href="#3-1-2-order-by关键字优化" class="headerlink" title="3.1.2 order by关键字优化"></a>3.1.2 order by关键字优化</h2><h3 id="1-Index-与-FileSort"><a href="#1-Index-与-FileSort" class="headerlink" title="1. Index 与 FileSort"></a>1. Index 与 FileSort</h3><ol><li><p>建表</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tblA
<span class="token punctuation">(</span>
    age   <span class="token keyword">INT</span><span class="token punctuation">,</span>
    birth <span class="token keyword">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    name  <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tblA<span class="token punctuation">(</span>age<span class="token punctuation">,</span> birth<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'Tom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tblA<span class="token punctuation">(</span>age<span class="token punctuation">,</span> birth<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'Jerry'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tblA<span class="token punctuation">(</span>age<span class="token punctuation">,</span> birth<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'Luci'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>建索引</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_A_ageBirth <span class="token keyword">ON</span> tblA<span class="token punctuation">(</span>age<span class="token punctuation">,</span> birth<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>两种排序</p><ul><li><p>情形一：全部排序</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tblA <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age<span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+-----------------------------+
| Extra                       |
+-----------------------------+
| Using filesort              |
+-----------------------------+</code></pre></li><li><p>情形二：序索引顺序</p><pre class="language-none"><code class="language-none">EXPLAIN SELECT age, birth FROM tblA WHERE age &gt; 20 ORDER BY age;
EXPLAIN SELECT age, birth FROM tblA WHERE age &#x3D; 20 ORDER BY birth;
EXPLAIN SELECT age, birth FROM tblA WHERE age &gt; 20 ORDER BY age,birth;
EXPLAIN SELECT age, birth FROM tblA WHERE birth &gt; &#39;2016-01-28 00:00:00&#39; ORDER BY age;</code></pre><pre class="language-none"><code class="language-none">+--------------------------+
| Extra                    |
+--------------------------+
| Using where; Using index |
+--------------------------+</code></pre></li><li><p>情形三：多字段</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> age<span class="token punctuation">,</span> birth <span class="token keyword">FROM</span> tblA <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> birth<span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> age<span class="token punctuation">,</span> birth <span class="token keyword">FROM</span> tblA <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> birth<span class="token punctuation">,</span>age<span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> age<span class="token punctuation">,</span> birth <span class="token keyword">FROM</span> tblA <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">ASC</span><span class="token punctuation">,</span> birth <span class="token keyword">DESC</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> age<span class="token punctuation">,</span> birth<span class="token punctuation">,</span> name <span class="token keyword">FROM</span> tblA <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age<span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+------------------------------------------+
| Extra                                    |
+------------------------------------------+
| Using index; Using filesort              |
+------------------------------------------+</code></pre></li></ul></li><li><p>使用 Index方式的情形</p><ul><li>Order by 语句使用索引最左前列</li><li>使用 WHERE 子句与 ORDER BY 子句条件列组合满足索引最左前列（即where使用索引的最左前缀定义为常量）</li><li>Order by 的字段都是升序，或者都是降序</li></ul></li></ol><h3 id="2-Filesort-的优化"><a href="#2-Filesort-的优化" class="headerlink" title="2. Filesort 的优化"></a>2. Filesort 的优化</h3><p>对于Filesort ， MySQL 有两种排序算法</p><ol><li>双路排序：MySQL4.1 之前，使用该方式排序<ul><li>首先从磁盘读取数据，然后在排序区sort buffer 中排序</li><li>如果sort buffer不够，则在临时表 temporary table 中存储排序结果</li><li>完成排序之后，再根据行指针回表读取记录，两次扫描磁盘，很耗时</li></ul></li><li>单路排序<ul><li>一次性取出满足条件的所有字段，然后在排序区 sort buffer 中排序后直接输出结果集。</li><li>排序时内存开销较大，但是排序效率比两次扫描算法要高</li><li>若数据量太大无法一次性取出则会导致多次I/O操作，反而降低了效率</li></ul></li><li>优化策略<ul><li>MySQL 通过比较系统变量 max_length_for_sort_data 的大小和Query语句取出的字段总大小， 来判定是否那种排序算法，如果max_length_for_sort_data 更大，那么使用第二种优化之后的算法；否则使用第一种</li><li>适当提高 sort_buffer_size 和 max_length_for_sort_data 系统变量，来增大排序区的大小，提高排序的效率</li></ul></li></ol><h2 id="3-1-3-优化-group-by-语句"><a href="#3-1-3-优化-group-by-语句" class="headerlink" title="3.1.3 优化 group by 语句"></a>3.1.3 优化 group by 语句</h2><h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h3><ol><li>GROUP BY 也同样会进行排序操作，先排序后分组</li><li>可以执行order by null 禁止排序，避免排序结果的消耗</li></ol><h3 id="2-案例"><a href="#2-案例" class="headerlink" title="2. 案例"></a>2. 案例</h3><ol><li><p>无索引</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> age <span class="token keyword">FROM</span> tblB <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> age<span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+---------------------------------+
| Extra                           |
+---------------------------------+
| Using temporary; Using filesort |
+---------------------------------+</code></pre></li><li><p>不排序</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> age <span class="token keyword">FROM</span> tblB <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> age <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+-----------------+
| Extra           |
+-----------------+
| Using temporary |
+-----------------+</code></pre></li><li><p>有索引</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_tblB_ageBirth <span class="token keyword">ON</span> tblB<span class="token punctuation">(</span>age<span class="token punctuation">,</span> birth<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> age <span class="token keyword">FROM</span> tblB <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> age<span class="token punctuation">;</span></code></pre><pre class="language-none"><code class="language-none">+-------------+
| Extra       |
+-------------+
| Using index |
+-------------+</code></pre></li></ol><h1 id="3-2-慢查询日志分析"><a href="#3-2-慢查询日志分析" class="headerlink" title="3.2 慢查询日志分析"></a>3.2 慢查询日志分析</h1><h2 id="3-2-1-说明"><a href="#3-2-1-说明" class="headerlink" title="3.2.1 说明"></a>3.2.1 说明</h2><ol><li>Mysql的查询讯日志是Mysql提供的一种日志记录，它用来记录在Mysql中响应时间超过阈值的语句</li><li>具体指运行时间超过long_query_time值得SQL，则会被记录到慢查询日志中。long_query_time的默认为10，意识是运行10秒以上的语句</li><li>默认Mysql没有开启慢查询，需要我们说动设置这个参数。如果不是调优需要，一般不建议开启该参数，会带来一定的性能影响</li></ol><h2 id="3-2-2-使用"><a href="#3-2-2-使用" class="headerlink" title="3.2.2 使用"></a>3.2.2 使用</h2><ol><li><p>查询是否开启</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'%slow_query_log%'</span><span class="token punctuation">;</span></code></pre></li><li><p>开启</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 0关闭，1开启</span>
<span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> slow_query_log <span class="token operator">=</span> <span class="token number">0</span><span class="token operator">|</span><span class="token number">1</span><span class="token punctuation">;</span></code></pre><p>只对当前数据库生效，重启失效</p></li><li><p>阈值时间</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 查看，默认为10秒</span>
<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'long_query_time'</span><span class="token punctuation">;</span>

<span class="token comment"># 修改</span>
<span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> long_query_time <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span></code></pre></li><li><p>查询</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 查询超过4秒的慢SQL</span>
<span class="token keyword">SELECT</span> sleep<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 查看系统有多少条记录</span>
<span class="token keyword">SHOW</span> <span class="token keyword">GLOBAL</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'%Slow_queries%'</span><span class="token punctuation">;</span></code></pre></li><li><p>配置</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># my.cnf</span>

<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
show_query_log <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
show_query_log_file<span class="token operator">=</span><span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>mysql_slow<span class="token punctuation">.</span>log
log_query_time<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>
log_output<span class="token operator">=</span><span class="token keyword">FILE</span></code></pre><h2 id="3-2-3-日志分析工具"><a href="#3-2-3-日志分析工具" class="headerlink" title="3.2.3 日志分析工具"></a>3.2.3 日志分析工具</h2></li><li><p>MySQL提供了日志分析工具mysqldumpslow</p></li><li><p>MySQL默认安装了该功能，在shell种使用</p></li><li><p>查看帮助</p><pre class="language-sh" data-language="sh"><code class="language-sh">mysqldumpslow --help;</code></pre><pre class="language-none"><code class="language-none">Usage: mysqldumpslow [ OPTS... ] [ LOGS... ]

Parse and summarize the MySQL slow query log. Options are

--verbose    verbose
--debug      debug
--help       write this text to standard output

-v           verbose
-d           debug
-s ORDER     what to sort by (al, at, ar, c, l, r, t), &#39;at&#39; is default
                al: average lock time
                ar: average rows sent
                at: average query time
                c: count
                l: lock time
                r: rows sent
                t: query time
-r           reverse the sort order (largest last instead of first)
-t NUM       just show the top n queries
-a           don&#39;t abstract all numbers to N and strings to &#39;S&#39;
-n NUM       abstract numbers with at least n digits within names
-g PATTERN   grep: only consider stmts that include this string
-h HOSTNAME  hostname of db server for *-slow.log filename (can be wildcard),
            default is &#39;*&#39;, i.e. match all
-i NAME      name of server instance (if using mysql.server startup script)
-l           don&#39;t subtract lock time from total time</code></pre><p>中文：</p><pre class="language-none"><code class="language-none">s:是表示按照何种方式排序

c:访问次数

i：锁定时间

r：返回记录

t：查询时间

al:平均锁定时间

ar：平均返回记录数

at：平均查询时间

t：即为返回前面多少条数据

g：后边搭配一个正则匹配模式，大小写不敏感</code></pre></li><li><p>常用</p><pre class="language-sh" data-language="sh"><code class="language-sh">mysqldumpslow -s r -t 10 &#x2F;data&#x2F;mysql&#x2F;mysql-slow.log  &#x2F;&#x2F;得到返回记录集最多的10个SQL
mysqldumpslow -s c -t 10 &#x2F;data&#x2F;mysql&#x2F;mysql-slow.log &#x2F;&#x2F;得到访问次数最多的10个SQL 
mysqldumpslow -s t -t 10 -g &quot;left join&quot; &#x2F;data&#x2F;mysql&#x2F;mysql-slow.log  &#x2F;&#x2F;得到按照时间排序的前10条里面含有做了连接的查询SQL
mysqldumpslow -s r -t 10 &#x2F;data&#x2F;mysql&#x2F;mysql-slow.log | more  &#x2F;&#x2F;另外建议在使用这些命令时结合|和more使用，否则有可能出现爆屏情况</code></pre></li></ol><h1 id="3-3-存储过程与函数"><a href="#3-3-存储过程与函数" class="headerlink" title="3.3 存储过程与函数"></a>3.3 存储过程与函数</h1><h2 id="3-3-1-简介"><a href="#3-3-1-简介" class="headerlink" title="3.3.1 简介"></a>3.3.1 简介</h2><ol><li><p>定义</p><ul><li>存储过程和函数是 事先经过编译并存储在数据库中的一段 SQL 语句的集合</li><li>存储过程和函数的区别在于函数必须有返回值，而存储过程没有</li></ul></li><li><p>建表</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> dept
<span class="token punctuation">(</span>
    id     <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    deptno <span class="token keyword">MEDIUMINT</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>
    dname  <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>        <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">""</span><span class="token punctuation">,</span>
    loc    <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span>        <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">""</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">innodb</span>
<span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> GBK<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> emp
<span class="token punctuation">(</span>
    id       <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    empno    <span class="token keyword">MEDIUMINT</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>
    ename    <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>        <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">""</span><span class="token punctuation">,</span>
    job      <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>         <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">""</span><span class="token punctuation">,</span>
    mgr      <span class="token keyword">MEDIUMINT</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>
    hiredate <span class="token keyword">DATE</span>               <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    sal      <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>      <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    comm     <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>      <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    deptno   <span class="token keyword">MEDIUMINT</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span>
<span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> GBK<span class="token punctuation">;</span></code></pre><h2 id="3-3-2-使用"><a href="#3-3-2-使用" class="headerlink" title="3.3.2 使用"></a>3.3.2 使用</h2></li><li><p>创建</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> procedure_name <span class="token punctuation">(</span><span class="token punctuation">[</span>proc_parameter<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
    <span class="token comment">-- SQL语句</span>
<span class="token keyword">end</span> <span class="token punctuation">;</span></code></pre><p>示例</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $

<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> pro_test2<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">SELECT</span> <span class="token string">'Hello word'</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> $

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></code></pre></li><li><p>调用</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CALL</span> procedure_name<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>查看</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 查看db_name中所有存储过程</span>
<span class="token keyword">SELECT</span> name <span class="token keyword">from</span> mysql<span class="token punctuation">.</span><span class="token keyword">proc</span> <span class="token keyword">WHERE</span> db<span class="token operator">=</span><span class="token string">'db_name'</span><span class="token punctuation">;</span>

<span class="token comment"># 查询存储过程中的状态信息</span>
<span class="token keyword">SHOW</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">STATUS</span><span class="token punctuation">;</span>

<span class="token comment"># </span>
<span class="token keyword">SHOW</span> <span class="token keyword">CREATE</span>  <span class="token keyword">PROCEDURE</span> db_name<span class="token punctuation">.</span>pro_name \G<span class="token punctuation">;</span></code></pre></li><li><p>删除</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> sp_name ；</code></pre></li></ol><h2 id="3-3-3-语法"><a href="#3-3-3-语法" class="headerlink" title="3.3.3 语法"></a>3.3.3 语法</h2><h3 id="1-变量"><a href="#1-变量" class="headerlink" title="1. 变量"></a>1. 变量</h3><ul><li>DECLARE：通过 DECLARE 可以定义一个局部变量，该变量的作用范围只能在 BEGIN…END 块中<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DECLARE</span> var_name<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token keyword">type</span> <span class="token punctuation">[</span><span class="token keyword">DEFAULT</span> <span class="token keyword">value</span><span class="token punctuation">]</span></code></pre></li><li>SET：直接赋值使用 SET<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> var_name <span class="token operator">=</span> expr <span class="token punctuation">[</span><span class="token punctuation">,</span> var_name <span class="token operator">=</span> expr<span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre></li><li>SELECT … INTO 进行赋值</li><li>示例<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> pro_test5<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">DECLARE</span> num <span class="token keyword">int</span> <span class="token keyword">DEFAULT</span> <span class="token number">9</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> num2 <span class="token keyword">int</span><span class="token punctuation">;</span>
    <span class="token keyword">SET</span> num <span class="token operator">=</span> num <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">SELECT</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">INTO</span> num2 <span class="token keyword">FROM</span> city<span class="token punctuation">;</span>
    <span class="token keyword">SELECT</span> num<span class="token punctuation">;</span>
    <span class="token keyword">SELECT</span> concat<span class="token punctuation">(</span><span class="token string">'city表中记录数为：'</span><span class="token punctuation">,</span> num2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></code></pre></li></ul><h3 id="2-游标"><a href="#2-游标" class="headerlink" title="2. 游标"></a>2. 游标</h3><ol><li><p>说明</p><ul><li>游标是用来存储查询结果集的数据类型</li><li>在存储过程和函数中可以使用光标对结果集进行循环的处理</li><li>光标的使用包括光标的声明、OPEN、FETCH 和 CLOSE</li></ul></li><li><p>语法</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 声明</span>
<span class="token keyword">DECLARE</span> cursor_name <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span> select_statement<span class="token punctuation">;</span>

<span class="token comment"># OPEN 游标</span>
<span class="token keyword">OPEN</span> cursor_name<span class="token punctuation">;</span>

<span class="token comment"># FETCH(指针前进，用于遍历)</span>
<span class="token keyword">FETCH</span> cursor_name <span class="token keyword">INTO</span> var_name <span class="token punctuation">[</span>var_name<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>

<span class="token comment"># 关闭</span>
<span class="token keyword">CLOSE</span> cursor_name<span class="token punctuation">;</span></code></pre></li><li><p>建表</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> emp
<span class="token punctuation">(</span>
    id     <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>     <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    name   <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'姓名'</span><span class="token punctuation">,</span>
    age    <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'年龄'</span><span class="token punctuation">,</span>
    salary <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'薪水'</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">innodb</span>
<span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8<span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emp<span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> salary<span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'金毛狮王'</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">3800</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'白眉鹰王'</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'青翼蝠王'</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">,</span> <span class="token number">2800</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'紫衫龙王'</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">1800</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>示例：循环遍历表内容</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> pro_test7<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>

    <span class="token keyword">DECLARE</span> e_id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> e_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> e_age <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> e_salary <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> has_data <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">DECLARE</span> emp_result <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp<span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> <span class="token keyword">EXIT</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> <span class="token operator">NOT</span> FOUND <span class="token keyword">SET</span> has_data<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">OPEN</span> emp_result<span class="token punctuation">;</span>

    <span class="token keyword">REPEAT</span>
        <span class="token keyword">FETCH</span> emp_result <span class="token keyword">INTO</span> e_id<span class="token punctuation">,</span> e_name<span class="token punctuation">,</span> e_age<span class="token punctuation">,</span> e_salary<span class="token punctuation">;</span>
        <span class="token keyword">SELECT</span> concat<span class="token punctuation">(</span><span class="token string">'id='</span><span class="token punctuation">,</span>e_id<span class="token punctuation">,</span><span class="token string">',name='</span><span class="token punctuation">,</span>e_name<span class="token punctuation">,</span><span class="token string">',age='</span><span class="token punctuation">,</span>e_age<span class="token punctuation">,</span><span class="token string">',salary='</span><span class="token punctuation">,</span>e_salary<span class="token punctuation">)</span><span class="token punctuation">;</span>
        until has_data<span class="token operator">=</span><span class="token number">0</span>
    <span class="token keyword">END</span> <span class="token keyword">REPEAT</span><span class="token punctuation">;</span>

    <span class="token keyword">CLOSE</span> emp_result<span class="token punctuation">;</span>
<span class="token keyword">END</span> $
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></code></pre></li></ol><h2 id="3-3-4-批量数据脚本"><a href="#3-3-4-批量数据脚本" class="headerlink" title="3.3.4 批量数据脚本"></a>3.3.4 批量数据脚本</h2><ol><li><p>创建随机函数</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> rand_string<span class="token punctuation">(</span>n <span class="token keyword">INT</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">DECLARE</span> chart_str <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> return_str <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">WHILE</span> i <span class="token operator">&lt;</span> n <span class="token keyword">DO</span>
        <span class="token keyword">SET</span> return_str <span class="token operator">=</span> concat<span class="token punctuation">(</span>return_str<span class="token punctuation">,</span> substring<span class="token punctuation">(</span>chart_str<span class="token punctuation">,</span> floor<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">52</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">SET</span> i <span class="token operator">=</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
    <span class="token keyword">RETURN</span> return_str<span class="token punctuation">;</span>
<span class="token keyword">END</span> $
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></code></pre><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> rand_num<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">SET</span> i <span class="token operator">=</span> floor<span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">+</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">RETURN</span> i<span class="token punctuation">;</span>
<span class="token keyword">END</span> $
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></code></pre></li><li><p>创建插入函数</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> insert_emp<span class="token punctuation">(</span><span class="token operator">IN</span> <span class="token keyword">START</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">IN</span> max_num <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">SET</span> AUTOCOMMIT <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">REPEAT</span>
        <span class="token keyword">SET</span> i <span class="token operator">=</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> atguigu<span class="token punctuation">.</span>emp<span class="token punctuation">(</span>empno<span class="token punctuation">,</span> ename<span class="token punctuation">,</span> job<span class="token punctuation">,</span> mgr<span class="token punctuation">,</span> hiredate<span class="token punctuation">,</span> sal<span class="token punctuation">,</span> comm<span class="token punctuation">,</span> deptno<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">START</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>rand_string<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'SALESMAN'</span><span class="token punctuation">,</span><span class="token number">0001</span><span class="token punctuation">,</span>CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">,</span><span class="token number">400</span><span class="token punctuation">,</span>rand_num<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    UNTIL i <span class="token operator">=</span> max_num
    <span class="token keyword">END</span> <span class="token keyword">REPEAT</span><span class="token punctuation">;</span>
    <span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> $
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></code></pre><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> insert_dept<span class="token punctuation">(</span><span class="token operator">IN</span> <span class="token keyword">start</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">IN</span> max_num <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">SET</span> autocommit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">REPEAT</span>
        <span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> dept<span class="token punctuation">(</span>deptno<span class="token punctuation">,</span> dname<span class="token punctuation">,</span> loc<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">start</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> ran_string<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ran_string<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    UNTIL i <span class="token operator">=</span> max_num
        <span class="token keyword">END</span> <span class="token keyword">REPEAT</span><span class="token punctuation">;</span>
    <span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> $
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></code></pre></li><li><p>插入</p><pre class="language-none"><code class="language-none">CALL insert_dept(100,10);

CALL insert_emp(100001,50000);</code></pre></li></ol><h1 id="3-4-Show-Profile"><a href="#3-4-Show-Profile" class="headerlink" title="3.4 Show Profile"></a>3.4 Show Profile</h1><h2 id="3-4-1-简介"><a href="#3-4-1-简介" class="headerlink" title="3.4.1 简介"></a>3.4.1 简介</h2><ol><li>Mysql从5.0.37版本开始增加了对 show profiles 和 show profile 语句的支持。show profiles 能够在做SQL优化时帮助我们了解时间都耗费到哪里去了</li><li>通过 have_profiling 参数，能够看到当前MySQL是否支持profile<pre class="language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">SELECT</span> @<span class="token variable">@have_profiling</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------------------+</span>
<span class="token operator">|</span> @<span class="token variable">@have_profiling</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+</span>
<span class="token operator">|</span> YES              <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+</span></code></pre></li></ol><h2 id="3-4-2-使用"><a href="#3-4-2-使用" class="headerlink" title="3.4.2 使用"></a>3.4.2 使用</h2><ol><li><p>默认是关闭的，可以在session中开启</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">set</span> profiling<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span></code></pre></li><li><p>查看</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 查看所有sql语句耗时</span>
<span class="token keyword">SHOW</span> PROFILES<span class="token punctuation">;</span>

<span class="token comment"># 查看具体的sql语句</span>
<span class="token keyword">SHOW</span> PROFILE <span class="token keyword">FOR</span> QUERY query_id<span class="token punctuation">;</span>

<span class="token comment"># 进一步选择all、cpu、block io 、context switch、page faults等明细类型</span>
<span class="token keyword">SHOW</span> PROFILE CPU <span class="token keyword">FOR</span> QUERY query_id<span class="token punctuation">;</span></code></pre></li><li><p>步骤</p><ul><li>开启功能</li><li>执行SQL语句</li><li>SHOW PROFILES 查看结果</li><li>诊断SQL，根据id进一步查看SQL问题：<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> PROFILE CPU<span class="token punctuation">,</span> BLOCK IO <span class="token keyword">FOR</span> QUERY query_id<span class="token punctuation">;</span></code></pre></li></ul></li></ol><ol start="4"><li><p>常见问题</p><ul><li>converting HEAP to MyISAM 查询结果太大，内存不够用，往磁盘上存数据了</li><li>creating tmp table 创建临时表</li><li>copying to tmp table on disk 把内存中的临时表复制到磁盘</li><li>locked</li></ul></li></ol><h1 id="3-5-全局查询日志"><a href="#3-5-全局查询日志" class="headerlink" title="3.5 全局查询日志"></a>3.5 全局查询日志</h1><ol><li><p>开启</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">set</span> <span class="token keyword">global</span> general_log <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> <span class="token keyword">global</span> log_output<span class="token operator">=</span><span class="token string">'TABLE'</span><span class="token punctuation">;</span></code></pre></li><li><p>查看</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mysql<span class="token punctuation">.</span>general_log<span class="token punctuation">;</span></code></pre></li></ol></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/MySQL/">MySQL</a> <a class="hover-with-bg" href="/categories/MySQL/MySQL%E9%AB%98%E7%BA%A7/">MySQL高级</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/mysql/">mysql</a></div></div><div class="post-prevnext row"><article class="post-prev col-6"><a href="/posts/30c53523/"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Chapter4 MySQL锁机制</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/posts/39055e0c/"><span class="hidden-mobile">Chapter2 索引优化</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><div class="disqus" style="width:100%"><div id="disqus_thread"></div><script>function loadDisqus(){addCssLink("https://cdn.jsdelivr.net/npm/disqusjs@1.0/dist/disqusjs.css"),addScript("https://cdn.jsdelivr.net/npm/disqusjs@1.0/dist/disqus.js",(function(){new DisqusJS({shortname:"Jacob",apikey:""})}))}waitElementVisible("disqus_thread",loadDisqus)</script><noscript>Please enable JavaScript to view the <a target="_blank" href="https://disqus.com/?ref_noscript" rel="nofollow noopener noopener">comments powered by Disqus.</a></noscript></div></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div id="tocbot"></div></div></div></div></div></main><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><footer class="mt-5"><div class="text-center py-3"><div><a href="https://github.com/" target="_blank" rel="nofollow noopener"><span>Github</span></a> <i class="iconfont icon-love"></i> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a></div><div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div><div><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script>var now=new Date;function createtime(){var n=new Date("10/06/2020 00:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="本站安全运行&nbsp"+dnum+"&nbsp天",document.getElementById("times").innerHTML=hnum+"&nbsp小时&nbsp"+mnum+"&nbsp分&nbsp"+snum+"&nbsp秒"}setInterval("createtime()",250)</script></div></div></footer><script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/main.js"></script><script src="/js/lazyload.js"></script><script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script><script src="/js/clipboard-use.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js"></script><script>$(document).ready((function(){var t=$("#board-ctn").offset().top;tocbot.init({tocSelector:"#tocbot",contentSelector:"#post-body",headingSelector:"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:3,scrollSmooth:!0,headingsOffset:-t}),$(".toc-list-item").length>0&&$("#toc").css("visibility","visible")}))</script><script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script><script>var typed=new Typed("#subtitle",{strings:["  ","Chapter3 查询截取分析&nbsp;"],cursorChar:"|",typeSpeed:90,loop:!0});typed.stop(),$(document).ready((function(){$(".typed-cursor").addClass("h2"),typed.start()}))</script><script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script><script>anchors.options={placement:"right",visible:"hover"};var el="h1,h2,h3,h4,h5,h6".split(","),res=[];for(item of el)res.push(".markdown-body > "+item);anchors.add(res.join(", "))</script><script src="/js/local-search.js"></script><script>var path="/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){searchFunc(path,"local-search-input","local-search-result"),this.onclick=null}</script><script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><script>$("#post img:not(.no-zoom img, img[no-zoom]), img[zoom]").each((function(){var t=document.createElement("a");$(t).attr("data-fancybox","images"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)}))</script></body></html>